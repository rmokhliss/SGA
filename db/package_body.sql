-- Start of DDL Script for Package Body API_SIF_MOBILE.MB_INTERFACE_PKG
-- Generated 14-Feb-21 19:47:37 from API_SIF_MOBILE@(DESCRIPTION =(ADDRESS_LIST =(ADDRESS = (PROTOCOL = TCP)(HOST = 172.18.1.199)(PORT = 1528)))(CONNECT_DATA =(SERVICE_NAME = afb12c)))

CREATE OR REPLACE 
PACKAGE BODY api_sif_mobile.mb_interface_pkg
IS


    PROCEDURE GETCARDSLIST (
        V_REQUEST    IN OUT NOCOPY CARDSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY CARDSLISTRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := CARDSLISTRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETCARDSLIST';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ (NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := NULL;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;

        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.CARDS := NULL;
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION
        RET := MB_INTERFACE_TOOLS_PKG.PROCESSCARDSLIST (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.CARDS := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETCARDSLIST',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A1: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETCARDSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
              NULL,
              V_REQUEST.INITIATOR.REQUESTID,
                'GETCARDSLIST',
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETCARDSLIST;

    PROCEDURE CREATECARD (
        V_REQUEST    IN OUT NOCOPY CREATECARDRQ,
        V_RESPONSE   IN OUT NOCOPY CREATECARDRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN

        V_RESPONSE := CREATECARDRS(NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT CREATECARD';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ (NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := NULL;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;

        --END CHECK REGISTRATION
        RET := MB_INTERFACE_TOOLS_PKG.PROCESSCREATECARD (V_REQUEST,V_RESPONSE);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('CREATECARD',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'CC1: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'CREATECARD',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
              NULL,
              V_REQUEST.INITIATOR.REQUESTID,
                'CREATECARD',
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END CREATECARD;

    PROCEDURE SECONDCARD (
        V_REQUEST    IN OUT NOCOPY SECONDCARDRQ,
        V_RESPONSE   IN OUT NOCOPY SECONDCARDRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN

        V_RESPONSE := SECONDCARDRS(NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT SECONDCARD';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;

        --END CHECK REGISTRATION
        RET := MB_INTERFACE_TOOLS_PKG.PROCESSSECONDCARD (V_REQUEST,V_RESPONSE);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('SECONDCARD',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'CC2: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'SECONDCARD',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
              NULL,
              V_REQUEST.INITIATOR.REQUESTID,
                'SECONDCARD',
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END SECONDCARD;

  PROCEDURE REPLACECARD (
        V_REQUEST    IN OUT NOCOPY REPLACECARDRQ,
        V_RESPONSE   IN OUT NOCOPY REPLACECARDRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN

        V_RESPONSE := REPLACECARDRS(NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT REPLACECARD';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;

        --END CHECK REGISTRATION
        RET := MB_INTERFACE_TOOLS_PKG.PROCESSREPLACECARD (V_REQUEST,V_RESPONSE);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('REPLACECARD',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'RP1: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'REPLACECARD',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
              NULL,
              V_REQUEST.INITIATOR.REQUESTID,
                'REPLACECARD',
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END REPLACECARD;

    PROCEDURE GETACCOUNTSLIST (
        V_REQUEST    IN OUT NOCOPY ACCOUNTSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY ACCOUNTSLISTRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := ACCOUNTSLISTRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETACCOUNTSLIST';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.ACCOUNTS := NULL;
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSACCOUNTSLIST (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.ACCOUNTS := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETACCOUNTSLIST',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A2: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETACCOUNTSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
              NULL,
              V_REQUEST.INITIATOR.REQUESTID,
                'GETACCOUNTSLIST',
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETACCOUNTSLIST;

    PROCEDURE GETTRANSACTIONSLIST (
        V_REQUEST    IN OUT NOCOPY TRANSACTIONSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY TRANSACTIONSLISTRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := TRANSACTIONSLISTRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETTRANSACTIONSLIST';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.TRANSACTIONS := NULL;
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSTRANSACTIONSLIST (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.TRANSACTIONS := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETTRANSACTIONSLIST',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A3: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETTRANSACTIONSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
              NULL,
              V_REQUEST.INITIATOR.REQUESTID,
                'GETTRANSACTIONSLIST',
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETTRANSACTIONSLIST;


    PROCEDURE GETLIMITSLIST (
        V_REQUEST    IN OUT NOCOPY LIMITSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY LIMITSLISTRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := LIMITSLISTRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETLIMITSLIST';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.LIMITS := NULL;
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSLIMITSLIST (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.LIMITS := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETLIMITSLIST',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A4: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETLIMITSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'GETLIMITSLIST',
                  NULL,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETLIMITSLIST;

    PROCEDURE GETCHANNELSLIST (
        V_REQUEST    IN OUT NOCOPY CHANNELSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY CHANNELSLISTRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := CHANNELSLISTRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETCHANNELSLIST';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.CHANNELS := NULL;
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSCHANNELSLIST (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.CHANNELS := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETCHANNELSLIST',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A5: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETCHANNELSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'GETCHANNELSLIST',
                  NULL,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETCHANNELSLIST;


    PROCEDURE GETCOUNTRYSLIST (
        V_REQUEST    IN OUT NOCOPY COUNTRYSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY COUNTRYSLISTRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := COUNTRYSLISTRS(NULL, NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETCOUNTRYSLIST';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.COUNTRYS := NULL;
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSRESTCOUNTRYSLIST (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.COUNTRYS := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETCOUNTRYSLIST',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A6: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETCOUNTRYSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'GETCOUNTRYSLIST',
                  NULL,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETCOUNTRYSLIST;


    PROCEDURE REQCHECKBOOK (
        V_REQUEST    IN OUT NOCOPY CHECKBOOKRQ,
        V_RESPONSE   IN OUT NOCOPY CHECKBOOKRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := CHECKBOOKRS(NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT REQCHECKBOOK';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := V_REQUEST.INITIATOR.ACOUNTNBR;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

       RET := MB_INTERFACE_TOOLS_PKG.PROCESSREQCHECKBOOK (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('REQCHECKBOOK',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A7: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'REQCHECKBOOK',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'REQCHECKBOOK',
                  NULL,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END REQCHECKBOOK;

    PROCEDURE SETSTATUS (
        V_REQUEST    IN OUT NOCOPY SETSTATUSRQ,
        V_RESPONSE   IN OUT NOCOPY SETSTATUSRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := SETSTATUSRS(NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT SETSTATUS';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF ((RET != MB_INTERFACE_TOOLS_PKG.OK) AND ((RET!=MB_INTERFACE_TOOLS_PKG.CARD_NOT_ACTIVE) OR (V_REQUEST.STATUS.CHANGETYPE!=0)))
        THEN
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSSTATUSCHANGE (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('SETSTATUS',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A8: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'SETSTATUS',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'SETSTATUS',
                  NULL,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END SETSTATUS;

    PROCEDURE REQPIN (
        V_REQUEST    IN OUT NOCOPY REQPINRQ,
        V_RESPONSE   IN OUT NOCOPY REQPINRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := REQPINRS(NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT REQPIN';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSREQPIN (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('REQPIN',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A9: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'REQPIN',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'REQPIN',
                  NULL,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END REQPIN;

    PROCEDURE REQRENEW (
        V_REQUEST    IN OUT NOCOPY REQRENEWRQ,
        V_RESPONSE   IN OUT NOCOPY REQRENEWRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := REQRENEWRS(NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT REQRENEW';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSREQRENEW (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('REQRENEW',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A9: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'REQRENEW',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'REQRENEW',
                  NULL,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END REQRENEW;

    PROCEDURE SETLIMIT (
        V_REQUEST    IN OUT NOCOPY SETLIMITRQ,
        V_RESPONSE   IN OUT NOCOPY SETLIMITRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN

        V_RESPONSE := SETLIMITRS(NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT SETLIMIT';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSLIMITCHANGE (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('SETLIMIT',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A10: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'SETLIMIT',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'SETLIMIT',
                  NULL,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END SETLIMIT;

    PROCEDURE SETCHANNEL (
        V_REQUEST    IN OUT NOCOPY SETCHANNELRQ,
        V_RESPONSE   IN OUT NOCOPY SETCHANNELRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN

        V_RESPONSE := SETCHANNELRS(NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT SETCHANNEL';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSCHANNELCHANGE (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('SETCHANNEL',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A11: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'SETCHANNEL',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'SETCHANNEL',
                  NULL,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END SETCHANNEL;

    PROCEDURE SETCOUNTRY (
        V_REQUEST    IN OUT NOCOPY SETCOUNTRYRQ,
        V_RESPONSE   IN OUT NOCOPY SETCOUNTRYRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN

        V_RESPONSE := SETCOUNTRYRS(NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT SETCOUNTRY';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

       RET := MB_INTERFACE_TOOLS_PKG.PROCESSCOUNTRYCHANGE (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('SETCOUNTRY',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A12: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'SETCOUNTRY',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'SETCOUNTRY',
                  NULL,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END SETCOUNTRY;

    PROCEDURE GETSTATISTICS (
        V_REQUEST    IN OUT NOCOPY STATISTICSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY STATISTICSRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := STATISTICSRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETSTATISTICS';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := NULL;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.statistic := NULL;
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;

        --END CHECK REGISTRATION
        RET := MB_INTERFACE_TOOLS_PKG.PROCESSSTATISTICS (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
        INSERT_TRACKING (270955,'not ok',0,0);
            V_RESPONSE.statistic := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETSTATISTICS',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A13: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETSTATISTICS',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'GETSTATISTICS',
                 NULL,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETSTATISTICS;

    PROCEDURE GETBALANCE (
        V_REQUEST    IN OUT NOCOPY BALANCERQ,
        V_RESPONSE   IN OUT NOCOPY BALANCERS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := BALANCERS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETBALANCE';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := V_REQUEST.INITIATOR.ACOUNTNBR;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.BALANCE := NULL;
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSBALANCE (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.BALANCE := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETBALANCE',
                                                V_RESPONSE.BALANCE.RETREFNBR,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A14: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETBALANCE',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'GETBALANCE',
                 V_RESPONSE.BALANCE.RETREFNBR,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETBALANCE;


    PROCEDURE GETMINISTAT (
        V_REQUEST    IN OUT NOCOPY MINISTATRQ,
        V_RESPONSE   IN OUT NOCOPY MINISTATRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := MINISTATRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETMINISTAT';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := V_REQUEST.INITIATOR.ACOUNTNBR;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.MINISTAT := NULL;
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSMINISTAT (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.MINISTAT := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETMINISTAT',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A15: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETMINISTAT',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'GETMINISTAT',
                 NULL,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETMINISTAT;

    PROCEDURE GETPRODUCTSLIST (
        V_REQUEST    IN OUT NOCOPY PRODUCTSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY PRODUCTSLISTRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
    BEGIN
        V_RESPONSE := PRODUCTSLISTRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETPRODUCTSLIST';

        RET := MB_INTERFACE_TOOLS_PKG.CHECKBANK(V_REQUEST.INITIATOR.BANKCODE, V_RESPONSE.STATUS);
        IF(RET != MB_INTERFACE_TOOLS_PKG.OK) THEN
            V_RESPONSE.PRODUCTS := NULL;
            GOTO END_PROCESS;
        END IF;

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSPRODUCTSLIST (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
        INSERT_TRACKING (270955,'not ok',0,0);
            V_RESPONSE.PRODUCTS := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETPRODUCTSLIST',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
             INSERT_TRACKING (270955,'SQLERRM1: '||SQLERRM,0,0);
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A16: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETPRODUCTSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'GETPRODUCTSLIST',
                NULL,
                V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETPRODUCTSLIST;

    PROCEDURE GETCOUNTRIESLIST (
        V_REQUEST    IN OUT NOCOPY COUNTRIESLISTRQ,
        V_RESPONSE   IN OUT NOCOPY COUNTRIESLISTRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
    BEGIN
        V_RESPONSE := COUNTRIESLISTRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETCOUNTRIESLIST';

        RET := MB_INTERFACE_TOOLS_PKG.CHECKBANK(V_REQUEST.INITIATOR.BANKCODE, V_RESPONSE.STATUS);
        IF(RET != MB_INTERFACE_TOOLS_PKG.OK) THEN
            V_RESPONSE.COUNTRIES := NULL;
            GOTO END_PROCESS;
        END IF;

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSCOUNTRIESLIST (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.COUNTRIES := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETCOUNTRIESLIST',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A17: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETCOUNTRIESLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'GETCOUNTRIESLIST',
                NULL,
                V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETCOUNTRIESLIST;


    PROCEDURE GETREASONSLIST (
        V_REQUEST    IN OUT NOCOPY REASONSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY REASONSLISTRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
    BEGIN
        V_RESPONSE := REASONSLISTRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETREASONSLIST';

        RET := MB_INTERFACE_TOOLS_PKG.CHECKBANK(V_REQUEST.INITIATOR.BANKCODE, V_RESPONSE.STATUS);
        IF(RET != MB_INTERFACE_TOOLS_PKG.OK) THEN
            V_RESPONSE.REASONS := NULL;
            GOTO END_PROCESS;
        END IF;

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSREASONSLIST (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.REASONS := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETREASONSLIST',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A18: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETREASONSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'GETREASONSLIST',
                NULL,
                V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETREASONSLIST;


    PROCEDURE GETCHECKSIZESLIST (
        V_REQUEST    IN OUT NOCOPY CHECKSIZESLISTRQ,
        V_RESPONSE   IN OUT NOCOPY CHECKSIZESLISTRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
    BEGIN
        V_RESPONSE := CHECKSIZESLISTRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETCHECKSIZESLIST';

        RET := MB_INTERFACE_TOOLS_PKG.CHECKBANK(V_REQUEST.INITIATOR.BANKCODE, V_RESPONSE.STATUS);
        IF(RET != MB_INTERFACE_TOOLS_PKG.OK) THEN
            V_RESPONSE.CHECKSIZES := NULL;
            GOTO END_PROCESS;
        END IF;

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSCHECKSIZESLIST (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.CHECKSIZES := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETCHECKSIZESLIST',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A19: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETCHECKSIZESLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'GETCHECKSIZESLIST',
                NULL,
                V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETCHECKSIZESLIST;

    PROCEDURE GETLOCATIONSLIST (
        V_REQUEST    IN OUT NOCOPY LOCATIONSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY LOCATIONSLISTRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
    BEGIN
        V_RESPONSE := LOCATIONSLISTRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT GETLOCATIONSLIST';

        RET := MB_INTERFACE_TOOLS_PKG.CHECKBANK(V_REQUEST.INITIATOR.BANKCODE, V_RESPONSE.STATUS);
        IF(RET != MB_INTERFACE_TOOLS_PKG.OK) THEN
            V_RESPONSE.LOCATIONS := NULL;
            GOTO END_PROCESS;
        END IF;

        RET := MB_INTERFACE_TOOLS_PKG.PROCESSLOCATIONSLIST (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.LOCATIONS := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('GETLOCATIONSLIST',
                                                NULL,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A20: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'GETLOCATIONSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'GETLOCATIONSLIST',
                NULL,
                V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END GETLOCATIONSLIST;

    PROCEDURE PINGAPI (
        V_REQUEST    IN OUT NOCOPY PINGSRVRQ,
        V_RESPONSE   IN OUT NOCOPY PINGSRVRS)
    IS
        RET                NUMBER;
        V_DATE_DUAL        DATE;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
    BEGIN
        V_RESPONSE := PINGSRVRS(NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT PINGAPI';

        BEGIN
            SELECT SYSDATE
                  INTO V_DATE_DUAL
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90015_C;
                    V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90015_D;
                    GOTO END_PROCESS;
            END;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('PINGAPI',
                                               NULL,
                                                V_REQUEST.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A21: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PINGAPI',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'PINGAPI',
                 NULL,
                 V_REQUEST.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END PINGAPI;

    PROCEDURE SETTRANSFER (
        V_REQUEST    IN OUT NOCOPY TRANSFERRQ,
        V_RESPONSE   IN OUT NOCOPY TRANSFERRS)
    IS
        RET                NUMBER;
        L_REQUEST_XML      XMLTYPE;
        L_RESPONSE_XML     XMLTYPE;
        V_REQREG REGISTRATIONRQ;
        V_RESREG REGISTRATIONRS;
    BEGIN
        V_RESPONSE := TRANSFERRS(NULL, NULL);
        V_RESPONSE.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_TRACE_C;
        V_RESPONSE.STATUS.ERRORDESC := 'INIT SETTRANSFER';

        --BEGIN CHECK REGISTRATION
        V_REQREG := REGISTRATIONRQ ( NULL, NULL, NULL);
        V_REQREG.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.ACOUNTNBR := V_REQUEST.INITIATOR.ACOUNTNBR;

        V_RESREG := REGISTRATIONRS (NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.WALLETREGISTRATIONCONTROL (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.AUTH := NULL;
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            GOTO END_PROCESS;
        END IF;
        --END CHECK REGISTRATION

       RET := MB_INTERFACE_TOOLS_PKG.PROCESSTRANSFER (V_REQUEST,V_RESPONSE);

        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.AUTH := NULL;
            GOTO END_PROCESS;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

       <<END_PROCESS>>
        L_REQUEST_XML := XMLTYPE (V_REQUEST);
        L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
        MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE ('SETTRANSFER',
                                                V_RESPONSE.AUTH.RETREFNBR,
                                                V_REQUEST.INITIATOR.REQUESTID,
                                                  L_REQUEST_XML,
                                                  L_RESPONSE_XML);
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'A22: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'SETTRANSFER',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            L_REQUEST_XML := XMLTYPE (V_REQUEST);
            L_RESPONSE_XML := XMLTYPE (V_RESPONSE);
            MB_INTERFACE_TOOLS_PKG.LOG_MB_EXCHANGE (
                'SETTRANSFER',
                 V_RESPONSE.AUTH.RETREFNBR,
                  V_REQUEST.INITIATOR.REQUESTID,
                L_REQUEST_XML,
                L_RESPONSE_XML);
    END SETTRANSFER;

END MB_INTERFACE_PKG;
/

-- Grants for Package Body
GRANT EXECUTE ON api_sif_mobile.mb_interface_pkg TO public
/


-- End of DDL Script for Package Body API_SIF_MOBILE.MB_INTERFACE_PKG

-- Start of DDL Script for Package Body API_SIF_MOBILE.MB_INTERFACE_TOOLS_PKG
-- Generated 14-Feb-21 19:47:38 from API_SIF_MOBILE@(DESCRIPTION =(ADDRESS_LIST =(ADDRESS = (PROTOCOL = TCP)(HOST = 172.18.1.199)(PORT = 1528)))(CONNECT_DATA =(SERVICE_NAME = afb12c)))

CREATE OR REPLACE 
PACKAGE BODY api_sif_mobile.mb_interface_tools_pkg
IS

    PROCEDURE LOG_MB_EXCHANGE (P_PROCEDURE_NAME    VARCHAR2,
                                P_AUT_CODE    AUTHORIZATION.AUT_CODE%TYPE,
                                P_REQUEST_ID    VARCHAR2,
                                P_REQUEST           XMLTYPE,
                                P_RESPONSE          XMLTYPE)
    IS
        PRAGMA AUTONOMOUS_TRANSACTION;
        V_SYSDATE         VARCHAR2 (14) := TO_CHAR (SYSDATE, 'YYYYMMDDHH24MISS');
        V_XML             XMLTYPE;
        L_JSON_REQUEST    XMLTYPE;
        L_JSON_RESPONSE    XMLTYPE;
    BEGIN
        --DBMS_OUTPUT.PUT_LINE (P_REQUEST.GETCLOBVAL ());
        L_JSON_REQUEST := MB_XML_TOOLS.XML2JSON (P_REQUEST);
        --DBMS_OUTPUT.PUT_LINE (REPLACE (L_JSON_REQUEST.GETCLOBVAL (), '&QUOT;', '"'));


        --DBMS_OUTPUT.PUT_LINE (P_RESPONSE.GETCLOBVAL ());
        if(nvl(P_AUT_CODE,0)!=1)
        then
            L_JSON_RESPONSE := MB_XML_TOOLS.XML2JSON (P_RESPONSE);
        else
            L_JSON_RESPONSE := null;
        end if;

        --DBMS_OUTPUT.PUT_LINE (REPLACE (L_JSON_RESPONSE.GETCLOBVAL (), '&QUOT;', '"'));


        INSERT INTO MB_EXCHANGE_LOGS
        VALUES (V_SYSDATE,
                P_PROCEDURE_NAME,
                P_AUT_CODE,
                P_REQUEST_ID,
                SUBSTR(L_JSON_REQUEST,1,3999),
                SUBSTR(L_JSON_RESPONSE,1,3999));


        COMMIT;
    EXCEPTION
        WHEN OTHERS
        THEN
            NULL;
    END LOG_MB_EXCHANGE;

    PROCEDURE TRACE_MB_EXCHANGE (
        P_PACKAGE_NAME         PROCESSING_TRACES.PACKAGE_NAME%TYPE,
        P_PROCEDURE_NAME       PROCESSING_TRACES.PROCEDURE_NAME%TYPE,
        P_TRACE_LINE           PROCESSING_TRACES.TRACE_LINE%TYPE,
        P_TRACE_DESCRIPTION    PROCESSING_TRACES.TRACE_DESCRIPTION%TYPE)
    IS
        PRAGMA AUTONOMOUS_TRANSACTION;

        V_ERROR_DESCRIPTION   PROCESSING_TRACES.ERROR_DESCRIPTION%TYPE;
        V_BACKTRACE           VARCHAR2 (512)
                                  := DBMS_UTILITY.FORMAT_ERROR_BACKTRACE;
        V_SYSDATE             VARCHAR2 (14)
                                  := TO_CHAR (SYSDATE, 'YYYYMMDDHH24MISS');
    BEGIN
        IF SQLCODE = 0
        THEN
            IF V_BACKTRACE IS NOT NULL
            THEN
                V_ERROR_DESCRIPTION := '[' || V_BACKTRACE || ']';
            END IF;
        ELSE
            V_ERROR_DESCRIPTION :=
                SUBSTR (SQLERRM, 1, 500) || ' [' || V_BACKTRACE || ']';
        END IF;

        INSERT INTO MB_PROCESSING_TRACES
        VALUES (V_SYSDATE,
                P_PACKAGE_NAME,
                P_PROCEDURE_NAME,
                P_TRACE_LINE,
                P_TRACE_DESCRIPTION,
                V_ERROR_DESCRIPTION);

        COMMIT;
    EXCEPTION
        WHEN OTHERS
        THEN
            NULL;
    END TRACE_MB_EXCHANGE;

    FUNCTION CHECKCUSTOMER (
        P_CUS_IDEN   IN     CUSTOMER_CARDHOLDER.CUS_IDEN%TYPE,
        P_CUS_CODE   OUT    CUSTOMER_CARDHOLDER.CUS_CODE%TYPE,
        P_STATUS  IN OUT NOCOPY STATUSSTRUCT)
        RETURN NUMBER
    IS
        P_CUS_CSR_CODE CUSTOMER_CARDHOLDER.CUS_CSR_CODE%TYPE;
        p_CUS_CCS_CODE CUSTOMER_CARDHOLDER.CUS_CCS_CODE%TYPE;
    BEGIN
        BEGIN
            SELECT CUS_CODE, CUS_CSR_CODE, CUS_CCS_CODE
              INTO P_CUS_CODE, P_CUS_CSR_CODE, p_CUS_CCS_CODE
              FROM CUSTOMER_CARDHOLDER
             WHERE CUS_IDEN = P_CUS_IDEN;
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                P_CUS_CODE := NULL;
        END;
        IF P_CUS_CODE IS NULL
        THEN                                                   -- NEW CUSTOMER
            P_STATUS.ERRORCODE := MB_RESP_PKG.WT_90000_C;
            P_STATUS.ERRORDESC := MB_RESP_PKG.WT_90000_D;
            RETURN CUSTOMER_NOT_EXIST;
        END IF;

        IF (p_CUS_CCS_CODE != 1 )
        THEN
            P_STATUS.ERRORCODE := MB_RESP_PKG.MB_90030_C;
            P_STATUS.ERRORDESC := MB_RESP_PKG.MB_90030_D;
            RETURN CUSTOMER_NOT_ACTIVE;
        END IF;

        RETURN CUSTOMER_ENROLLED;
        EXCEPTION
        WHEN OTHERS
        THEN
            P_STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            P_STATUS.ERRORDESC := 'En1: '||SUBSTR (SQLERRM, 1,74); MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'CHECKCUSTOMER',
                $$PLSQL_LINE,
                P_STATUS.ERRORDESC);
            RETURN ERROR;
    END CHECKCUSTOMER;

    FUNCTION CHECKBANK (
        P_BAN_CODE   IN     BANK.BAN_CODE%TYPE,
        P_STATUS  IN OUT NOCOPY STATUSSTRUCT)
        RETURN NUMBER
    IS
      v_count number :=0 ;
    BEGIN
        BEGIN

            SELECT count(*)
            into v_count
            FROM BANK WHERE BAN_CODE = P_BAN_CODE;
            EXCEPTION
            WHEN OTHERS
            THEN
                v_count := 0;
        END;
        IF (v_count = 0 )
        THEN
            P_STATUS.ERRORCODE := MB_RESP_PKG.MB_90023_C;
            P_STATUS.ERRORDESC := MB_RESP_PKG.MB_90023_D;
            RETURN BANK_NOT_EXIST;
        ELSE
            RETURN OK;
        END IF;
        EXCEPTION
        WHEN OTHERS
        THEN
            P_STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            P_STATUS.ERRORDESC := 'BN1: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'CHECKBANK',
                $$PLSQL_LINE,
                P_STATUS.ERRORDESC);
        RETURN ERROR;
    END CHECKBANK;

    FUNCTION CHECKCARD (
        P_CAR_CODE   IN     CARD.CAR_CODE%TYPE,
        P_CAR_CUS_CODE   IN    CARD.CAR_CUS_CODE%TYPE,
        P_STATUS  IN OUT NOCOPY STATUSSTRUCT)
        RETURN NUMBER
    IS
        V_COUNT       NUMBER;
        V_CAR_CUS_CODE CARD.CAR_CUS_CODE%TYPE;
        V_CAR_CST_CODE CARD.CAR_CST_CODE%TYPE;
    BEGIN
        BEGIN
            SELECT CAR_CUS_CODE, CAR_CST_CODE
              INTO V_CAR_CUS_CODE, V_CAR_CST_CODE
              FROM CARD
             WHERE CAR_CODE = P_CAR_CODE;
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                V_CAR_CUS_CODE := NULL;
        END;

        IF V_CAR_CUS_CODE IS NULL
        THEN                                                   -- NEW CARD
            P_STATUS.ERRORCODE := MB_RESP_PKG.MB_90010_C;
            P_STATUS.ERRORDESC := MB_RESP_PKG.MB_90010_D;
            RETURN CARD_NOT_EXIST;
        END IF;

        IF V_CAR_CUS_CODE != P_CAR_CUS_CODE
        THEN                                            -- CARD EXIST
            P_STATUS.ERRORCODE := MB_RESP_PKG.MB_90007_C;
            P_STATUS.ERRORDESC := MB_RESP_PKG.MB_90007_D;
            RETURN CARD_NOT_CORRECT;
        END IF;

        IF(V_CAR_CST_CODE!=2)
        THEN
            P_STATUS.ERRORCODE := MB_RESP_PKG.MB_90031_C;
            P_STATUS.ERRORDESC := MB_RESP_PKG.MB_90031_D;
            RETURN CARD_NOT_ACTIVE;
        END IF;

        RETURN CARD_CORRECT;

        EXCEPTION
        WHEN OTHERS
        THEN
            P_STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            P_STATUS.ERRORDESC := 'En2: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'CHECKCARD',
                $$PLSQL_LINE,
                P_STATUS.ERRORDESC);
            RETURN ERROR;
    END CHECKCARD;

    FUNCTION CHECKACCOUNT (
        P_ACC_NUMB   IN     ACCOUNT.ACC_NUMB%TYPE,
        P_ACC_CUS_CODE   IN    ACCOUNT.ACC_CUS_CODE%TYPE,
        P_STATUS  IN OUT NOCOPY STATUSSTRUCT)
        RETURN NUMBER
    IS
        V_COUNT       NUMBER;
        V_ACC_CUS_CODE ACCOUNT.ACC_CUS_CODE%TYPE;
        V_ACC_CURR_CODE ACCOUNT.ACC_CURR_CODE%TYPE;
        V_ACC_AST_CODE ACCOUNT.ACC_AST_CODE%TYPE;
    BEGIN

        BEGIN
            SELECT ACC_CUS_CODE, ACC_CURR_CODE, ACC_AST_CODE
              INTO V_ACC_CUS_CODE, V_ACC_CURR_CODE,  V_ACC_AST_CODE
              FROM ACCOUNT
             WHERE ACC_NUMB_MXP = P_ACC_NUMB
             AND ROWNUM =1;
        EXCEPTION
            WHEN OTHERS
            THEN
                V_ACC_CUS_CODE := NULL;
        END;
        IF V_ACC_CUS_CODE IS NULL
        THEN                                          -- NEW ACCOUNT
            P_STATUS.ERRORCODE := MB_RESP_PKG.MB_90006_C;
            P_STATUS.ERRORDESC := MB_RESP_PKG.MB_90006_D;
            RETURN ACCOUNT_NOT_EXIST;
        END IF;
        IF V_ACC_CUS_CODE != P_ACC_CUS_CODE
        THEN
             P_STATUS.ERRORCODE := MB_RESP_PKG.MB_90009_C;
             P_STATUS.ERRORDESC := MB_RESP_PKG.MB_90009_D;
             RETURN ACCOUNT_NOT_CORRECT;
        END IF;
        IF (V_ACC_CURR_CODE!=37)--not XOF
        THEN
             P_STATUS.ERRORCODE := MB_RESP_PKG.MB_90011_C;
             P_STATUS.ERRORDESC := MB_RESP_PKG.MB_90011_D;
             RETURN ACCOUNT_NOT_MAD;
        END IF;
        IF (V_ACC_AST_CODE!=1)--not active
        THEN
             P_STATUS.ERRORCODE := MB_RESP_PKG.MB_90032_C;
             P_STATUS.ERRORDESC := MB_RESP_PKG.MB_90032_D;
             RETURN ACCOUNT_NOT_ACTIVE;
        END IF;

        RETURN ACCOUNT_CORRECT;

        EXCEPTION
        WHEN OTHERS
        THEN
            P_STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            P_STATUS.ERRORDESC := 'En3: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'CHECKACCOUNT',
                $$PLSQL_LINE,
                P_STATUS.ERRORDESC);
            RETURN ERROR;
    END CHECKACCOUNT;

    FUNCTION WALLETREGISTRATIONCONTROL (
        V_REQUEST    IN OUT NOCOPY REGISTRATIONRQ,
        V_RESPONSE   IN OUT NOCOPY REGISTRATIONRS)
        RETURN NUMBER
    IS
        RET         NUMBER;
        RER         NUMBER;
        P_CUS_CODE  CUSTOMER_CARDHOLDER.CUS_CODE%TYPE;
        P_STATUS STATUSSTRUCT;
    BEGIN
        P_STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        P_STATUS.REQUESTID := V_RESPONSE.STATUS.REQUESTID;
        P_STATUS.ERRORCODE := MB_RESP_PKG.MB_90019_C;
        P_STATUS.ERRORDESC := MB_RESP_PKG.MB_90019_D;
        RER := ERROR;

        RET := CHECKCUSTOMER(V_REQUEST.CLIENTID, P_CUS_CODE, P_STATUS);
        IF( RET = CUSTOMER_ENROLLED) THEN
            BEGIN
                IF V_REQUEST.CARDCODE IS NOT NULL THEN
                    RER := CHECKCARD(V_REQUEST.CARDCODE, P_CUS_CODE, P_STATUS);
                    IF( RER = CARD_CORRECT) THEN
                            RETURN OK;--CARD_NOT_ACTIVE
                    END IF;
                ELSIF V_REQUEST.ACOUNTNBR IS NOT NULL THEN
                    IF( CHECKACCOUNT(V_REQUEST.ACOUNTNBR, P_CUS_CODE, P_STATUS) = ACCOUNT_CORRECT) THEN
                            RETURN OK;
                    END IF;
                ELSE
                    RETURN OK;
                END IF;
            END;
          END IF;
       V_RESPONSE.STATUS := P_STATUS;
       RETURN RER;

    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P0: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'WALLETREGISTRATIONCONTROL',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END WALLETREGISTRATIONCONTROL;

    FUNCTION PROCESSCARDSLIST (
        V_REQUEST    IN OUT NOCOPY CARDSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY CARDSLISTRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_COUNT           NUMBER;
        P_COUNT           NUMBER (1) := 0;
        P_CTN_LABE        CARD_TYPE_NETWORK.CTN_LABE%TYPE;
        P_CPR_CODE        CARD_PROGRAM.CPR_CODE%TYPE;
        P_CPR_LABE        CARD_PROGRAM.CPR_LABE%TYPE;

      CURSOR CARDS_CUR (
            V_CUS_IDEN    CUSTOMER_CARDHOLDER.CUS_IDEN%TYPE)
        IS
            SELECT  CAR_CODE AS CARDCODE, CAR_NUMB, NVL (MASK_PAN ('Y', CAR_NUMB), '0') AS PCIPAN,
                    SUBSTR(NVL (TRIM(CAR_CHLD_NAME), CAR_CHLD_FIRS_NAME),1,25)  AS NAMEPRINTED,
                    NVL(CAR_REPL_NEW_EXPI_DATE, CAR_EXPI_DATE) AS EXPIRYDATE,
                    DECODE (CAR_CST_CODE, 2, 1, 0) CARDSTATUS,
                    CAR_CPR_CODE, CPR_LABE
            FROM CARD CA, CUSTOMER_CARDHOLDER CU, CARD_PROGRAM CP
            WHERE CUS_IDEN = V_CUS_IDEN
            AND CAR_CUS_CODE = CUS_CODE
            AND CPR_CODE = CAR_CPR_CODE
            AND TO_CHAR(NVL(CAR_REPL_NEW_EXPI_DATE, CAR_EXPI_DATE),'YYMM') >= TO_CHAR(SYSDATE,'YYMM');

   BEGIN

     V_COUNT:=0;
     V_RESPONSE.CARDS := NULL;
     V_RESPONSE.CARDS := CARDSRESULT ();

   /*  V_RESPONSE.CARDS.EXTEND;
     V_RESPONSE.CARDS (1) :=CARDSTRUCT (12456, '4256XXXXXXXX1145','HASSAN NOURI','12','mastercard',SYSDATE,2000,1,0);

     V_RESPONSE.CARDS.EXTEND;
     V_RESPONSE.CARDS (2) :=CARDSTRUCT (25845, '4256XXXXXXXX6698','HASSAN NOURI','25','visa',SYSDATE,1500,1,0);*/

        FOR CARDS_ROW IN CARDS_CUR (V_REQUEST.INITIATOR.CLIENTID)
        LOOP

            V_COUNT := V_COUNT + 1;
            V_RESPONSE.CARDS.EXTEND;
            V_RESPONSE.CARDS (V_COUNT) :=
                CARDSTRUCT (NULL,NULL,
                                NULL,NULL,
                                NULL,NULL,
                                NULL,NULL,
                                1);
            V_RESPONSE.CARDS (V_COUNT).CARDCODE := CARDS_ROW.CARDCODE;
            V_RESPONSE.CARDS (V_COUNT).PCIPAN := CARDS_ROW.PCIPAN;
            V_RESPONSE.CARDS (V_COUNT).NAMEPRINTED := CARDS_ROW.NAMEPRINTED;
            V_RESPONSE.CARDS (V_COUNT).EXPIRYDATE := CARDS_ROW.EXPIRYDATE;
            V_RESPONSE.CARDS (V_COUNT).PRODUCTCODE := CARDS_ROW.CAR_CPR_CODE;
            V_RESPONSE.CARDS (V_COUNT).PRODUCTDESC := CARDS_ROW.CPR_LABE;
            V_RESPONSE.CARDS (V_COUNT).LOYALTYBALANCE := 200;
            V_RESPONSE.CARDS (V_COUNT).ACTIVATION := CARDS_ROW.CARDSTATUS;


           BEGIN
                SELECT  COUNT ( * )
                  INTO    P_COUNT
                  FROM    OPPOSED_CARD_SAIS A
                  WHERE   A.OCS_STAT = 'OPPO'
                    AND   A.OCS_NUMB = CARDS_ROW.CAR_NUMB
                    AND   A.OCS_OPPO_DATE = ( SELECT  MAX(B.OCS_OPPO_DATE)
                                              FROM    OPPOSED_CARD_SAIS B
                                              WHERE   B.OCS_NUMB = CARDS_ROW.CAR_NUMB );
            EXCEPTION
                WHEN OTHERS THEN P_COUNT := 0;
            END;

            IF (P_COUNT > 0) THEN
                V_RESPONSE.CARDS (V_COUNT).OPPOSITION :=0;
            END IF;

        END LOOP;
        IF(V_COUNT =0)THEN
            V_RESPONSE.CARDS := NULL;
        END IF;
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

    RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.CARDS := NULL;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P1: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSCARDSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSCARDSLIST;


    FUNCTION PROCESSACCOUNTSLIST (
        V_REQUEST    IN OUT NOCOPY ACCOUNTSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY ACCOUNTSLISTRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_COUNT           NUMBER;
        P_COUNT           NUMBER (1) := 0;

        CURSOR ACCOUNTS_CUR (V_CARDCODE NUMBER)
        IS

           SELECT  ACC_NUMB AS ACCOUNTNBR, ACC_AVAI_AMOU AS AVAILABLE,ACC_CURR_CODE AS CURRENCY_CODE,
            DECODE(ACC_ATY_CODE,1,1,4,2,2,4,3) AS ACCOUNTTYPE ,DECODE(ACC_AST_CODE,1,1,0) AS ACCOUNTSTATUS
            FROM CARD CA, ACCOUNT AC, CARDHOLDER_ROUTING CR
            WHERE CAR_CODE = V_CARDCODE
             AND CRO_PAN = CAR_NUMB
             AND ACC_CODE = CRO_ACC_CODE;

    BEGIN
     V_COUNT:=0;

     V_RESPONSE.ACCOUNTS := NULL;
     V_RESPONSE.ACCOUNTS := ACCOUNTSRESULT ();

     /* V_RESPONSE.ACCOUNTS.EXTEND;
     V_RESPONSE.ACCOUNTS (1) :=ACCOUNTSTRUCT (200.00, 200.00,'MAD','MAD',SYSDATE,
                                    'RETRAIT GAB SALAM','RETRAIT','245897458249',124584,0,'000',' ');
     V_RESPONSE.ACCOUNTS.EXTEND;
     V_RESPONSE.ACCOUNTS (2) :=ACCOUNTSTRUCT (20.000, 220.00,'EUR','MAD',SYSDATE,
                                    'E-PAIEMENT AMAZON','E-PAIEMENT','142578411147',885965,1,'000',' ');
        */

        FOR ACCOUNT_ROW IN ACCOUNTS_CUR (V_REQUEST.INITIATOR.CARDCODE)
        LOOP
            V_COUNT := V_COUNT + 1;
            V_RESPONSE.ACCOUNTS.EXTEND;
            V_RESPONSE.ACCOUNTS (V_COUNT) :=
                ACCOUNTSTRUCT (NULL,NULL,NULL,NULL,
                                NULL,NULL,NULL);

            V_RESPONSE.ACCOUNTS (V_COUNT).ACCOUNTNBR := ACCOUNT_ROW.ACCOUNTNBR;
            IF(ACCOUNT_ROW.AVAILABLE<0)
            THEN
                V_RESPONSE.ACCOUNTS (V_COUNT).AVAILABLE := ACCOUNT_ROW.AVAILABLE*-1;
                V_RESPONSE.ACCOUNTS (V_COUNT).TYPEAVAILABLE := 0;
            ELSE
                V_RESPONSE.ACCOUNTS (V_COUNT).AVAILABLE := ACCOUNT_ROW.AVAILABLE;
                V_RESPONSE.ACCOUNTS (V_COUNT).TYPEAVAILABLE := 1;
            END IF;


            BEGIN
                SELECT CUR_ALPH_CODE,CUR_IDE
                INTO V_RESPONSE.ACCOUNTS (V_COUNT).CURRENCY,V_RESPONSE.ACCOUNTS (V_COUNT).CURRENCYISO
                FROM CURRENCY
                WHERE CUR_CODE=ACCOUNT_ROW.CURRENCY_CODE;
            EXCEPTION
            WHEN OTHERS
            THEN
                V_RESPONSE.ACCOUNTS (V_COUNT).CURRENCYISO := NULL;
                V_RESPONSE.ACCOUNTS (V_COUNT).CURRENCY := NULL;
            END;
                V_RESPONSE.ACCOUNTS (V_COUNT).ACCOUNTTYPE := ACCOUNT_ROW.ACCOUNTTYPE;
                V_RESPONSE.ACCOUNTS (V_COUNT).ACCOUNTSTATUS := ACCOUNT_ROW.ACCOUNTSTATUS;


       END LOOP;

        IF(V_COUNT =0)THEN
            V_RESPONSE.ACCOUNTS := NULL;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.ACCOUNTS := NULL;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P2: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSACCOUNTSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSACCOUNTSLIST;


    FUNCTION PROCESSTRANSACTIONSLIST (
        V_REQUEST    IN OUT NOCOPY TRANSACTIONSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY TRANSACTIONSLISTRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_COUNT           NUMBER;
        P_COUNT           NUMBER (1) := 0;
        P_AMOUNTMIN       NUMBER(9,3) := 0;
        P_AMOUNTMAX       NUMBER(9,3) := 0;
        P_NBRTRANS        NUMBER(2) := 0;

       CURSOR TRANS_CUR (V_CARDCODE NUMBER,
            V_STARTDATE DATE,V_ENDDATE DATE,V_AMOUNTMIN NUMBER,V_AMOUNTMAX NUMBER,V_NBRTRANS NUMBER)
        IS
            SELECT NVL(AUT_TRAN_AMOU_F004,0) AS  ORIGINAMOUNT, NVL(AUT_BILL_AMOU_F006,0) AS CONVERTEDAMOUNT,
                AUT_TRAN_CURR_F049 AS ORIGINCURRENCY, AUT_BILL_CURR_F051 AS ACCOUNTCURRENCY,
                AUT_REQU_SYST_TIME AS DATETIME, AUT_CARD_ACCP_NAME_LOC_F043 AS LONGLABEL,
                TTY_TYPE_LABE AS SHORTLABEL,AUT_RETR_REF_NUMB_F037 AS RETREFNBR,
                AUT_CODE AS AUTCODE, AUT_RESP_CODE_F039, AUT_MESS_TEXT_F044_01, AUT_REVE_STAT, AUT_MATC_STAT, AUT_VALI_STAT,
                DECODE(TCO_CHLD_SIGN,'D',0,1) SIGNTRX
            FROM AUTHORIZATION, TRANSACTION_TYPE, CARD, TRANSACTION_CODE
            WHERE AUT_TRAN_TYPE_CODE=TTY_TYPE_CODE
                AND TCO_CODE=AUT_TRAN_CODE
                AND AUT_PRIM_ACCT_NUMB_F002=CAR_NUMB
                AND CAR_CODE = V_CARDCODE
                AND AUT_REQU_SYST_TIME >= NVL (V_STARTDATE, AUT_REQU_SYST_TIME)
                AND AUT_REQU_SYST_TIME <= NVL (V_ENDDATE, AUT_REQU_SYST_TIME)
                AND AUT_TRAN_AMOU_F004 >= NVL (V_AMOUNTMIN, AUT_TRAN_AMOU_F004)
                AND AUT_TRAN_AMOU_F004 <= NVL (V_AMOUNTMAX, AUT_TRAN_AMOU_F004)
                AND  ROWNUM < NVL(V_NBRTRANS, 10)+1
            ORDER BY AUT_REQU_SYST_TIME DESC;
    BEGIN
     V_COUNT:=0;

     V_RESPONSE.TRANSACTIONS := NULL;
     V_RESPONSE.TRANSACTIONS := TRANSACTIONSRESULT ();
INSERT_TRACKING (270955,'V_STARTDATE:'||V_REQUEST.FILTER.STARTDATE,0,0);
INSERT_TRACKING (270955,'V_ENDDATE:'||V_REQUEST.FILTER.ENDDATE,0,0);

     /* V_RESPONSE.TRANSACTIONS.EXTEND;
     V_RESPONSE.TRANSACTIONS (1) :=TRANSACTIONSTRUCT (200.00, 200.00,'MAD','MAD',SYSDATE,
                                    'RETRAIT GAB SALAM','RETRAIT','245897458249',124584,0,'000',' ');
     V_RESPONSE.TRANSACTIONS.EXTEND;
     V_RESPONSE.TRANSACTIONS (2) :=TRANSACTIONSTRUCT (20.000, 220.00,'EUR','MAD',SYSDATE,
                                    'E-PAIEMENT AMAZON','E-PAIEMENT','142578411147',885965,1,'000',' ');
        */
         P_AMOUNTMIN := V_REQUEST.FILTER.AMOUNTMIN;
         P_AMOUNTMAX := V_REQUEST.FILTER.AMOUNTMAX;
         P_NBRTRANS  := V_REQUEST.FILTER.NBRTRANS;
        IF(P_AMOUNTMIN = -1)THEN
            P_AMOUNTMIN := NULL;
        END IF;

        IF(P_AMOUNTMAX = -1)THEN
            P_AMOUNTMAX := NULL;
        END IF;

        IF(P_NBRTRANS = -1)THEN
            P_NBRTRANS := NULL;
        END IF;

        FOR TRANS_ROW IN TRANS_CUR (V_REQUEST.INITIATOR.CARDCODE, V_REQUEST.FILTER.STARTDATE, V_REQUEST.FILTER.ENDDATE,
                                        P_AMOUNTMIN, P_AMOUNTMAX,
                                        P_NBRTRANS)
        LOOP
            V_COUNT := V_COUNT + 1;
            V_RESPONSE.TRANSACTIONS.EXTEND;
            V_RESPONSE.TRANSACTIONS (V_COUNT) :=
                TRANSACTIONSTRUCT (NULL,NULL,NULL,NULL,
                                NULL,NULL,NULL,NULL,
                                NULL,NULL,NULL,NULL,NULL,NULL,NULL);

            V_RESPONSE.TRANSACTIONS (V_COUNT).ORIGINAMOUNT := TRANS_ROW.ORIGINAMOUNT;
            V_RESPONSE.TRANSACTIONS (V_COUNT).CONVERTEDAMOUNT := TRANS_ROW.CONVERTEDAMOUNT;
            V_RESPONSE.TRANSACTIONS (V_COUNT).ORIGINCURRENCYISO := TRANS_ROW.ORIGINCURRENCY;
            V_RESPONSE.TRANSACTIONS (V_COUNT).ACCOUNTCURRENCYISO := TRANS_ROW.ACCOUNTCURRENCY;
            BEGIN
                SELECT CUR_ALPH_CODE INTO V_RESPONSE.TRANSACTIONS (V_COUNT).ORIGINCURRENCY
                FROM CURRENCY
                WHERE CUR_IDE=TRANS_ROW.ORIGINCURRENCY;
            EXCEPTION
            WHEN OTHERS
            THEN
                V_RESPONSE.TRANSACTIONS (V_COUNT).ORIGINCURRENCY := NULL;
            END;

            BEGIN
                SELECT CUR_ALPH_CODE INTO V_RESPONSE.TRANSACTIONS (V_COUNT).ACCOUNTCURRENCY
                FROM CURRENCY
                WHERE CUR_IDE=TRANS_ROW.ACCOUNTCURRENCY;
            EXCEPTION
            WHEN OTHERS
            THEN
                V_RESPONSE.TRANSACTIONS (V_COUNT).ACCOUNTCURRENCY := NULL;
            END;

            V_RESPONSE.TRANSACTIONS (V_COUNT).DATETIME := TRANS_ROW.DATETIME;
            V_RESPONSE.TRANSACTIONS (V_COUNT).LONGLABEL := TRANS_ROW.LONGLABEL;
            V_RESPONSE.TRANSACTIONS (V_COUNT).SHORTLABEL := TRANS_ROW.SHORTLABEL;
            V_RESPONSE.TRANSACTIONS (V_COUNT).RETREFNBR := TRANS_ROW.RETREFNBR;
            V_RESPONSE.TRANSACTIONS (V_COUNT).AUTCODE := TRANS_ROW.AUTCODE;
            V_RESPONSE.TRANSACTIONS (V_COUNT).RESCODE := ' ';
            V_RESPONSE.TRANSACTIONS (V_COUNT).RESMSG := ' ';
            V_RESPONSE.TRANSACTIONS (V_COUNT).SENSTRX := TRANS_ROW.SIGNTRX;

            IF TRANS_ROW.AUT_RESP_CODE_F039 = '000' THEN

             V_RESPONSE.TRANSACTIONS (V_COUNT).STATUS := 1;
             IF TRANS_ROW.AUT_REVE_STAT = 'N' THEN
                IF TRANS_ROW.AUT_VALI_STAT = 'VALI' THEN
                    V_RESPONSE.TRANSACTIONS (V_COUNT).STATUS := 1;--VALIDE
                ELSE
                    V_RESPONSE.TRANSACTIONS (V_COUNT).STATUS := 0;--EN  ATT VALIDATION
                END IF;
             ELSE
                V_RESPONSE.TRANSACTIONS (V_COUNT).STATUS := 2;--ANNULE
             END IF;
            ELSE
                V_RESPONSE.TRANSACTIONS (V_COUNT).STATUS := 3;--REJETE
                V_RESPONSE.TRANSACTIONS (V_COUNT).RESCODE := TRANS_ROW.AUT_RESP_CODE_F039;
                V_RESPONSE.TRANSACTIONS (V_COUNT).RESMSG := TRANS_ROW.AUT_MESS_TEXT_F044_01;
            END IF;

       END LOOP;

        IF(V_COUNT =0)THEN
            V_RESPONSE.TRANSACTIONS := NULL;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.TRANSACTIONS := NULL;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P3: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSTRANSACTIONSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSTRANSACTIONSLIST;

    FUNCTION PROCESSLIMITSLIST (
        V_REQUEST    IN OUT NOCOPY LIMITSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY LIMITSLISTRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_COUNT           NUMBER;
        V_IBR_IRP_CODE    NUMBER;
       CURSOR LIMIT_CUR (V_CARDCODE NUMBER, V_IRPCODE NUMBER)
        IS
            SELECT B.CCO_CODE REFID, DECODE(CCO_PER_CODE,21,0,3,1,5,2,3) PERIOD, DECODE(CCO_TCO_CODE,'07000',1,0) TRX_TYPE,
            B.CCO_TRAN_MIN MIN_AMOUNT_CARD, B.CCO_TRAN_MAX MAX_AMOUNT_CARD,
            B.CCO_TRAN_CUMU_MAX MAX_PER_AMOUNT_CARD, B.CCO_TRAN_CURR_AMOU MAX_PER_NBR_CARD,
             IRR_TRAN_MIN MIN_AMOUNT_PRODUCT, IRR_TRAN_MAX MAX_AMOUNT_PRODUCT,
             IRR_TRAN_CUMU_MAX MAX_PER_AMOUNT_PRODUCT, IRR_TRAN_CUMU_NBR MAX_PER_NBR_PRODUCT
            FROM CUST_CHLD_ONLI_RISK A, CUST_CHLD_ONLI_RISK_RECO B, ISSU_BANK_RISK_MANA C, ISSU_BANK_RISK_MANA_RECO D
            WHERE CCO_CAR_CODE = V_CARDCODE
                AND B.CCO_CCO_CODE = A.CCO_CODE
                AND CCO_PCA_CODE IS NULL
                AND CCO_TCO_CODE IN (07000,12000,05000)
                AND IBR_IRP_CODE=V_IRPCODE
                AND nvl(irr_pca_code,0) = nvl(CCO_PCA_CODE,0)
                AND nvl(IBR_PER_CODE,0)=nvl(CCO_PER_CODE,0)
                AND IRR_IBR_CODE = IBR_CODE
                AND nvl(IRR_TCO_CODE,'0') = nvl(CCO_TCO_CODE,'0');
    BEGIN
     V_COUNT:=0;
     V_RESPONSE.LIMITS := NULL;
     V_RESPONSE.LIMITS := LIMITSRESULT ();

    /* V_RESPONSE.LIMITS.EXTEND;
     V_RESPONSE.LIMITS (1) :=LIMITSTRUCT (1, 'PAIEMENT', 1, 110, 2200.00, 5300.00,LIMITBASESTRUCT (11450.00, 2001.00, 3002.00, 3));

     V_RESPONSE.LIMITS.EXTEND;
     V_RESPONSE.LIMITS (2) :=LIMITSTRUCT (2, 'RETRAIT', 1, 140, 25000.00, 56000.00,LIMITBASESTRUCT (11450.00, 2001.00, 3002.00, 3));

*/

    BEGIN
        SELECT   cpr_irp_code
          INTO   V_IBR_IRP_CODE
          FROM   CARD, CARD_PROGRAM
         WHERE   CAR_CODE = V_REQUEST.INITIATOR.CARDCODE
         AND CAR_CPR_CODE = CPR_CODE;
        EXCEPTION
            WHEN OTHERS
            THEN
                V_IBR_IRP_CODE := NULL;
    END;

        FOR LIMIT_ROW IN LIMIT_CUR (V_REQUEST.INITIATOR.CARDCODE, V_IBR_IRP_CODE)
        LOOP
          V_COUNT := V_COUNT + 1;
            V_RESPONSE.LIMITS.EXTEND;
            V_RESPONSE.LIMITS (V_COUNT) :=
                LIMITSTRUCT (NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,
                                NULL,NULL,NULL,NULL,NULL);

              V_RESPONSE.LIMITS (V_COUNT).trxtype := LIMIT_ROW.TRX_TYPE;
            V_RESPONSE.LIMITS (V_COUNT).period := LIMIT_ROW.PERIOD;
            V_RESPONSE.LIMITS (V_COUNT).currencyISO := 952;
            V_RESPONSE.LIMITS (V_COUNT).currency := 'XOF';
            V_RESPONSE.LIMITS (V_COUNT).maxperamountcrd := LIMIT_ROW.MAX_PER_AMOUNT_CARD;
            V_RESPONSE.LIMITS (V_COUNT).maxperamountprd := LIMIT_ROW.MAX_PER_AMOUNT_PRODUCT;

       END LOOP;

        IF(V_COUNT =0)THEN
            V_RESPONSE.LIMITS := NULL;
        END IF;

     V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
     V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.LIMITS := NULL;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P4: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSLIMITSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSLIMITSLIST;

    FUNCTION PROCESSCHANNELSLIST (
        V_REQUEST    IN OUT NOCOPY CHANNELSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY CHANNELSLISTRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_COUNT           NUMBER;
       CURSOR CHANNEL_CUR(V_CARDCODE NUMBER)
        IS
            SELECT CNL_CODE, CNL_NAME, DECODE(CHR_CNL_CODE,NULL,1,0) CHANNEL_STATUS
                FROM  CHANNEL,CHANNELS_RESTRICTED
                WHERE CNL_CODE=CHR_CNL_CODE(+)
                AND CHR_CAR_CODE(+) = V_CARDCODE;

    BEGIN
     V_COUNT:=0;
     V_RESPONSE.CHANNELS := NULL;
     V_RESPONSE.CHANNELS := CHANNELSRESULT ();

    /* V_RESPONSE.CHANNELS.EXTEND;
     V_RESPONSE.CHANNELS (1) :=CHANNELSTRUCT (1, 'PAIEMENT', 1, 110, 2200.00, 5300.00,CHANNELBASESTRUCT (11450.00, 2001.00, 3002.00, 3));

     V_RESPONSE.CHANNELS.EXTEND;
     V_RESPONSE.CHANNELS (2) :=CHANNELSTRUCT (2, 'RETRAIT', 1, 140, 25000.00, 56000.00,CHANNELBASESTRUCT (11450.00, 2001.00, 3002.00, 3));

*/

       FOR CHANNEL_ROW IN CHANNEL_CUR(V_REQUEST.INITIATOR.CARDCODE)
        LOOP
          V_COUNT := V_COUNT + 1;
            V_RESPONSE.CHANNELS.EXTEND;
            V_RESPONSE.CHANNELS (V_COUNT) :=
                CHANNELSTRUCT (NULL,NULL,NULL);

            V_RESPONSE.CHANNELS (V_COUNT).channelcode := CHANNEL_ROW.CNL_CODE;
            V_RESPONSE.CHANNELS (V_COUNT).channelname := CHANNEL_ROW.CNL_NAME;
            V_RESPONSE.CHANNELS (V_COUNT).channelstatus := CHANNEL_ROW.CHANNEL_STATUS;

       END LOOP;


        IF(V_COUNT =0)THEN
            V_RESPONSE.CHANNELS := NULL;
        END IF;

     V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
     V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.CHANNELS := NULL;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P5: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSCHANNELSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSCHANNELSLIST;

    FUNCTION PROCESSSTATUSCHANGE (
        V_REQUEST    IN OUT NOCOPY SETSTATUSRQ,
        V_RESPONSE   IN OUT NOCOPY SETSTATUSRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
    BEGIN


        CASE V_REQUEST.STATUS.CHANGETYPE
          WHEN 0 THEN--ACTIVATION
            BEGIN
                RET := ACTIVATION(V_REQUEST, V_RESPONSE);
            END;
          WHEN 1 THEN--OPPOSITION
            BEGIN
               RET := OPPOSITION(V_REQUEST, V_RESPONSE);
            END;
          WHEN 2 THEN--MOTO
            BEGIN
                RET := MOTO(V_REQUEST, V_RESPONSE);
            END;
          WHEN 3 THEN--PAYMENT
            BEGIN
                RET := PAYMENT(V_REQUEST, V_RESPONSE);
            END;
          ELSE RETURN ERROR;
       END CASE;

            IF RET = OK
            THEN
                V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
                V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;
            END IF;

        RETURN RET;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P6: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSSTATUSCHANGE',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSSTATUSCHANGE;

    FUNCTION ACTIVATION(
        V_REQUEST    IN OUT NOCOPY SETSTATUSRQ,
        V_RESPONSE   IN OUT NOCOPY SETSTATUSRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_CAR_CST_CODE CARD.CAR_CST_CODE%TYPE;
    BEGIN
       BEGIN
            SELECT CAR_CST_CODE
            INTO V_CAR_CST_CODE
            FROM CARD
            WHERE CAR_CODE = V_REQUEST.INITIATOR.CARDCODE;
        EXCEPTION WHEN OTHERS THEN
           ROLLBACK;
           V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
           V_RESPONSE.STATUS.ERRORDESC := 'P7: '||SUBSTR (SQLERRM, 1,74);
           MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
               $$PLSQL_UNIT,
               'ACTIVATION',
               $$PLSQL_LINE,
               V_RESPONSE.STATUS.ERRORDESC);
           RETURN ERROR;
        END;
        IF(V_CAR_CST_CODE NOT IN (5,2))THEN
             V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90001_C;
             V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90001_D;
            RETURN ERROR;
        END IF;
       BEGIN
            UPDATE card
            SET CAR_CST_CODE = DECODE(V_REQUEST.STATUS.STATUS,1,2,0,5)
            WHERE CAR_CODE = V_REQUEST.INITIATOR.CARDCODE;
            COMMIT;
        EXCEPTION WHEN OTHERS THEN
           ROLLBACK;
           V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
           V_RESPONSE.STATUS.ERRORDESC := 'P8: '||SUBSTR (SQLERRM, 1,74);
           MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
               $$PLSQL_UNIT,
               'ACTIVATION',
               $$PLSQL_LINE,
               V_RESPONSE.STATUS.ERRORDESC);
           RETURN ERROR;
        END;

       V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;
        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P9: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'ACTIVATION',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END;

    FUNCTION OPPOSITION(
        V_REQUEST    IN OUT NOCOPY SETSTATUSRQ,
        V_RESPONSE   IN OUT NOCOPY SETSTATUSRS)
        RETURN NUMBER
    IS
        RET                 NUMBER;
        V_CAR_CUS_CODE      CARD.CAR_CUS_CODE%TYPE;
        V_CAR_NUMB          CARD.CAR_NUMB%TYPE;
        V_CAR_BAN_CODE      CARD.CAR_BAN_CODE%TYPE;
        V_CAR_EXPI_DATE     CARD.CAR_EXPI_DATE%TYPE;
        V_CAR_CHLD_NAME     CARD.CAR_CHLD_NAME%TYPE;
        P_OCS_STAT          OPPOSED_CARD_SAIS.OCS_STAT%TYPE;
        P_OCA_CODE          NUMBER;
    BEGIN
        BEGIN
            SELECT   CAR_CUS_CODE, CAR_NUMB, CAR_BAN_CODE, NVL(CAR_REPL_NEW_EXPI_DATE, CAR_EXPI_DATE), CAR_CHLD_NAME
              INTO   V_CAR_CUS_CODE, V_CAR_NUMB, V_CAR_BAN_CODE, V_CAR_EXPI_DATE, V_CAR_CHLD_NAME
              FROM   CARD
             WHERE   CAR_CODE = V_REQUEST.INITIATOR.CARDCODE;
            EXCEPTION
                WHEN OTHERS
                THEN
                    V_CAR_NUMB := NULL;
        END;

        BEGIN
            SELECT   OCS_CODE,
                     OCS_STAT
              INTO   P_OCA_CODE,
                     P_OCS_STAT
              FROM   OPPOSED_CARD_SAIS
             WHERE   OCS_NUMB = V_CAR_NUMB
                     AND OCS_OPPO_DATE IN (SELECT   MAX (OCS_OPPO_DATE)
                                             FROM   OPPOSED_CARD_SAIS
                                            WHERE   OCS_NUMB = V_CAR_NUMB);
            EXCEPTION
                WHEN OTHERS
                THEN
                    P_OCA_CODE := NULL;
         END;

        CASE V_REQUEST.STATUS.STATUS
          WHEN 0 THEN
            BEGIN
                 IF (P_OCA_CODE IS NOT NULL) AND (NVL (P_OCS_STAT, 'OPPO') = 'OPPO')
                 THEN
                    RETURN OK;
                 END IF;

                 BEGIN
                    INSERT INTO OPPOSED_CARD_SAIS (OCS_CODE,OCS_NUMB,OCS_EXP_DATE, OCS_CARD_HOLD, OCS_DATE_INCI,OCS_OPPO_DATE,OCS_DIFF_NATI,OCS_DIFF_INTE,
                                            OCS_OMO_CODE,OCS_AUTH_RESP_CODE,OCS_RESP_ACTI_CODE,OCS_USE_CODE, OCS_TEXT,OCS_STAT,OCS_BAN_CODE)
                    VALUES(XOPPOSED_CARD_SAIS.NEXTVAL,V_CAR_NUMB,V_CAR_EXPI_DATE, V_CAR_CHLD_NAME, SYSDATE,SYSDATE,'N','N',8,'04',2,34251,'OPPOSED WITH MOBILE:'||V_REQUEST.STATUS.MOTIF,'OPPO',V_CAR_BAN_CODE);
                    COMMIT;
                 EXCEPTION WHEN OTHERS THEN
                    ROLLBACK;
                    V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
                    V_RESPONSE.STATUS.ERRORDESC := 'p10: '||SUBSTR (SQLERRM, 1,74);
                    MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                        $$PLSQL_UNIT,
                        'OPPOSITION',
                        $$PLSQL_LINE,
                        V_RESPONSE.STATUS.ERRORDESC);
                    RETURN ERROR;
                 END;
                  --  CARD_PERSONALIZATION_PKG.PROCESS_PERSO_FEES_SPEC(V_CAR_NUMB,'O');
            END;
          WHEN 1 THEN
                BEGIN
                     IF (P_OCA_CODE IS NOT NULL) AND (NVL (P_OCS_STAT, 'OPPO') = 'WITH')
                     THEN
                        RETURN OK;
                     END IF;

                     BEGIN
                        INSERT INTO OPPOSED_CARD_SAIS (OCS_CODE,OCS_NUMB,OCS_EXP_DATE, OCS_CARD_HOLD,OCS_OPPO_DATE,
                                                OCS_USE_CODE, OCS_TEXT,OCS_STAT,OCS_BAN_CODE)
                        VALUES(XOPPOSED_CARD_SAIS.NEXTVAL,V_CAR_NUMB,V_CAR_EXPI_DATE, V_CAR_CHLD_NAME, SYSDATE,34251,'WITHRAWEL MOBILE','WITH',V_CAR_BAN_CODE);
                       COMMIT;
                     EXCEPTION WHEN OTHERS THEN
                        ROLLBACK;
                        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
                        V_RESPONSE.STATUS.ERRORDESC := 'P11: '||SUBSTR (SQLERRM, 1,74);
                        MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                            $$PLSQL_UNIT,
                            'OPPOSITION',
                            $$PLSQL_LINE,
                            V_RESPONSE.STATUS.ERRORDESC);
                        RETURN ERROR;
                     END;
                  --  CARD_PERSONALIZATION_PKG.PROCESS_PERSO_FEES_SPEC(V_CAR_NUMB,'O');
                END;
          ELSE RETURN ERROR;
       END CASE;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;
        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P12: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'OPPOSITION',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END;

    FUNCTION MOTO(
        V_REQUEST    IN OUT NOCOPY SETSTATUSRQ,
        V_RESPONSE   IN OUT NOCOPY SETSTATUSRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
    BEGIN

       BEGIN
            UPDATE CARD
            SET CAR_MAIL_ORDE = DECODE(V_REQUEST.STATUS.STATUS,1,'Y',2,'N')
            WHERE CAR_CODE = V_REQUEST.INITIATOR.CARDCODE;
            COMMIT;
        EXCEPTION WHEN OTHERS THEN
           ROLLBACK;
           V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
           V_RESPONSE.STATUS.ERRORDESC := 'P13: '||SUBSTR (SQLERRM, 1,74);
           MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
               $$PLSQL_UNIT,
               'MOTO',
               $$PLSQL_LINE,
               V_RESPONSE.STATUS.ERRORDESC);
           RETURN ERROR;
        END;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;
        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P14: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'MOTO',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END;

    FUNCTION PAYMENT(
        V_REQUEST    IN OUT NOCOPY SETSTATUSRQ,
        V_RESPONSE   IN OUT NOCOPY SETSTATUSRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
    BEGIN

       BEGIN
            UPDATE CARD
            SET CAR_INTE_ORDE = DECODE(V_REQUEST.STATUS.STATUS,1,'Y',0,'N')
            WHERE CAR_CODE = V_REQUEST.INITIATOR.CARDCODE;
            COMMIT;
        EXCEPTION WHEN OTHERS THEN
           ROLLBACK;
           V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
           V_RESPONSE.STATUS.ERRORDESC := 'P15: '||SUBSTR (SQLERRM, 1,74);
           MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
               $$PLSQL_UNIT,
               'PAYMENT',
               $$PLSQL_LINE,
               V_RESPONSE.STATUS.ERRORDESC);
           RETURN ERROR;
        END;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P16: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PAYMENT',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END;

    FUNCTION PROCESSLIMITCHANGE (
        V_REQUEST    IN OUT NOCOPY SETLIMITRQ,
        V_RESPONSE   IN OUT NOCOPY SETLIMITRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_CCO_CODE NUMBER (10,0);
        V_CCO_CODE_RC NUMBER (10,0);
        V_CCO_PER_CODE  NUMBER (10,0);
        V_CCO_TCO_CODE  VARCHAR (10);
        V_MAXAUTHAMOUNT  NUMBER (15,3);
    BEGIN


    FOR l_index IN V_REQUEST.LIMITS.FIRST..V_REQUEST.LIMITS.LAST
    LOOP

        BEGIN
            SELECT A.CCO_CODE, B.CCO_CODE, A.CCO_PER_CODE, B.CCO_TCO_CODE
                INTO V_CCO_CODE, V_CCO_CODE_RC, V_CCO_PER_CODE, V_CCO_TCO_CODE
            FROM CUST_CHLD_ONLI_RISK A, CUST_CHLD_ONLI_RISK_RECO B
            WHERE CCO_CAR_CODE=V_REQUEST.INITIATOR.CARDCODE
                AND A.CCO_PER_CODE = DECODE(V_REQUEST.LIMITS(l_index).period,0,21,1,3,2,5,1)
                AND B.CCO_TCO_CODE = DECODE(V_REQUEST.LIMITS(l_index).trxtype,0,'05000','07000')
                AND B.CCO_CCO_CODE=A.CCO_CODE
                AND CCO_PCA_CODE IS NULL;
                EXCEPTION
                        WHEN OTHERS
                        THEN
                        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90004_C;
                        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90004_D;
                        RETURN ERROR;
        END;

        BEGIN
            SELECT NVL(IRR_TRAN_CUMU_MAX,0) AS MAXAUTHAMOUNT
            INTO V_MAXAUTHAMOUNT
            FROM CARD, CARD_PROGRAM, ISSUER_RISK_PROGRAM, ISSU_BANK_RISK_MANA, ISSU_BANK_RISK_MANA_RECO
            WHERE CAR_CODE=V_REQUEST.INITIATOR.CARDCODE
            AND CAR_CPR_CODE = CPR_CODE
            AND CPR_IRP_CODE = IRP_CODE
            AND IRP_CODE = IBR_IRP_CODE
            AND NVL(IBR_PER_CODE,0) = NVL(V_CCO_PER_CODE,0)
            AND IBR_CODE = IRR_IBR_CODE
            AND NVL(IRR_TCO_CODE,'0') = NVL(V_CCO_TCO_CODE,'0')
            AND IRR_PCA_CODE IS NULL
            AND  ROWNUM = 1;
            EXCEPTION
                    WHEN OTHERS
                    THEN
                    V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90003_C;
                    V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90003_D;
                    RETURN ERROR;
        END;

        IF(V_REQUEST.LIMITS(L_INDEX).MAXPERAMOUNTCRD > V_MAXAUTHAMOUNT)
        THEN
             V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90008_C;
             V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90008_D;
             RETURN ERROR;
       END IF;

         IF(V_REQUEST.LIMITS(L_INDEX).MAXPERAMOUNTCRD != V_MAXAUTHAMOUNT)
        THEN

           BEGIN
                UPDATE CUST_CHLD_ONLI_RISK_RECO
                SET  CCO_TRAN_CUMU_MAX = V_REQUEST.LIMITS(L_INDEX).MAXPERAMOUNTCRD
                WHERE CCO_CODE = V_CCO_CODE_RC;
                COMMIT;
            EXCEPTION WHEN OTHERS THEN
               ROLLBACK;
               V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
               V_RESPONSE.STATUS.ERRORDESC := 'P17: '||SUBSTR (SQLERRM, 1,74);
               MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                   $$PLSQL_UNIT,
                   'PROCESSLIMITCHANGE',
                   $$PLSQL_LINE,
                   V_RESPONSE.STATUS.ERRORDESC);
               RETURN ERROR;
            END;
         END IF;
    END LOOP;

    V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
    V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

    RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P18: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSLIMITCHANGE',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSLIMITCHANGE;

    FUNCTION PROCESSCHANNELCHANGE (
        V_REQUEST    IN OUT NOCOPY SETCHANNELRQ,
        V_RESPONSE   IN OUT NOCOPY SETCHANNELRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_RESTRICTED NUMBER (1):=0;
    BEGIN


    FOR l_index IN V_REQUEST.CHANNELS.FIRST..V_REQUEST.CHANNELS.LAST
    LOOP

        BEGIN
            SELECT count(*)
            INTO V_RESTRICTED
            FROM channel
            WHERE CNL_CODE=V_REQUEST.CHANNELS(l_index).channelcode;
                EXCEPTION
                        WHEN OTHERS
                        THEN
                        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90021_C;
                        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90021_D;
                        RETURN ERROR;
        END;

        BEGIN
            SELECT count(*)
            INTO V_RESTRICTED
            FROM CHANNELS_RESTRICTED
            WHERE CHR_CAR_CODE = V_REQUEST.INITIATOR.CARDCODE
            AND CHR_CNL_CODE = V_REQUEST.CHANNELS(l_index).channelcode;
                EXCEPTION
                        WHEN OTHERS
                        THEN
                        V_RESTRICTED := 0;
        END;

        IF(V_RESTRICTED=1 and V_REQUEST.CHANNELS(l_index).channelstatus=1)
        THEN
            BEGIN
                DELETE
                FROM CHANNELS_RESTRICTED
                WHERE CHR_CAR_CODE = V_REQUEST.INITIATOR.CARDCODE
                AND CHR_CNL_CODE = V_REQUEST.CHANNELS(l_index).channelcode;
                    EXCEPTION
                        WHEN OTHERS
                        THEN
                        NULL;
            END;
        END IF;

        IF(V_RESTRICTED=0 and V_REQUEST.CHANNELS(l_index).channelstatus=0)
        THEN
            BEGIN
                INSERT INTO CHANNELS_RESTRICTED (CHR_CNL_CODE, CHR_CAR_CODE, CHR_USR_TYPE,CHR_USE_CODE,CHR_DATE)
                    VALUES ( V_REQUEST.CHANNELS(l_index).channelcode,V_REQUEST.INITIATOR.CARDCODE,'MOBILE',null,sysdate);
            EXCEPTION
                WHEN OTHERS
                THEN
                NULL;
            END;
        END IF;
        commit;
    END LOOP;


    V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
    V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

    RETURN OK;

    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P19: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSCHANNELCHANGE',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSCHANNELCHANGE;

   FUNCTION PROCESSRESTCOUNTRYSLIST (
        V_REQUEST    IN OUT NOCOPY COUNTRYSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY COUNTRYSLISTRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_COUNT           NUMBER;
        V_CRE_COU_FLG       NUMBER(1);

       CURSOR COUNTRY_CUR(V_CARDCODE NUMBER)
        IS
            SELECT COU_CODE, COU_IDEN, COU_NAME, substr(nvl(COU_NAME,'XX'),0,2) ISO_ALPHA
                FROM  COUNTRY,COUNTRIES_ACCEPTED
                WHERE COA_COU_CODE=COU_CODE
                AND COA_CAR_CODE = V_CARDCODE;

    BEGIN
     V_COUNT:=0;
     V_RESPONSE.COUNTRYS := NULL;
     V_RESPONSE.COUNTRYS := COUNTRYSRESULT ();

    /* V_RESPONSE.COUNTRYS.EXTEND;
     V_RESPONSE.COUNTRYS (1) :=COUNTRYSTRUCT (1, 'PAIEMENT', 1, 110, 2200.00, 5300.00,COUNTRYBASESTRUCT (11450.00, 2001.00, 3002.00, 3));

     V_RESPONSE.COUNTRYS.EXTEND;
     V_RESPONSE.COUNTRYS (2) :=COUNTRYSTRUCT (2, 'RETRAIT', 1, 140, 25000.00, 56000.00,COUNTRYBASESTRUCT (11450.00, 2001.00, 3002.00, 3));

*/
    BEGIN
        SELECT   CRE_COU_FLG
          INTO   V_CRE_COU_FLG
          FROM   CARD_RESTRICTIONS
         WHERE   CRE_CAR_CODE = V_REQUEST.INITIATOR.CARDCODE;
        EXCEPTION
            WHEN OTHERS
            THEN
                V_CRE_COU_FLG := 0;
    END;
    IF(V_CRE_COU_FLG=1)
    THEN
       FOR COUNTRY_ROW IN COUNTRY_CUR(V_REQUEST.INITIATOR.CARDCODE)
        LOOP
          V_COUNT := V_COUNT + 1;
            V_RESPONSE.COUNTRYS.EXTEND;
            V_RESPONSE.COUNTRYS (V_COUNT) :=
                COUNTRYSTRUCT (NULL,NULL,NULL,NULL);

            V_RESPONSE.COUNTRYS (V_COUNT).countrycode := COUNTRY_ROW.COU_CODE;
            V_RESPONSE.COUNTRYS (V_COUNT).countryiden := COUNTRY_ROW.COU_IDEN;
            V_RESPONSE.COUNTRYS (V_COUNT).countrydesc := COUNTRY_ROW.COU_NAME;
            V_RESPONSE.COUNTRYS (V_COUNT).countryiso  := COUNTRY_ROW.ISO_ALPHA;

       END LOOP;
    END IF;

    V_RESPONSE.RESTRICTION := nvl(V_CRE_COU_FLG,0);
    IF(V_COUNT =0)THEN
        V_RESPONSE.COUNTRYS := NULL;
    END IF;

     V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
     V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.COUNTRYS := NULL;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P20: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSRESTCOUNTRYSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSRESTCOUNTRYSLIST;


    FUNCTION PROCESSCOUNTRYCHANGE (
        V_REQUEST    IN OUT NOCOPY SETCOUNTRYRQ,
        V_RESPONSE   IN OUT NOCOPY SETCOUNTRYRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_RESTRICTED NUMBER (1):=0;
    BEGIN

        BEGIN
            BEGIN
                  UPDATE CARD_RESTRICTIONS
                  SET CRE_COU_FLG = V_REQUEST.RESTRICTION, CRE_DATE=SYSDATE
                  WHERE CRE_CAR_CODE=V_REQUEST.INITIATOR.CARDCODE;
                    EXCEPTION
                        WHEN OTHERS
                        THEN
                        NULL;
            END;

            IF (SQL%ROWCOUNT = 0) THEN
                    BEGIN
                        INSERT INTO CARD_RESTRICTIONS (CRE_CAR_CODE, CRE_CHN_FLG, CRE_COU_FLG,CRE_DATE)
                            VALUES ( V_REQUEST.INITIATOR.CARDCODE,0,V_REQUEST.RESTRICTION,SYSDATE);
                    EXCEPTION
                        WHEN OTHERS
                        THEN
                        NULL;
                    END;
            END IF;
        END;

        IF(V_REQUEST.RESTRICTION = 0)
        THEN
            BEGIN
                DELETE  FROM COUNTRIES_ACCEPTED
                  WHERE COA_CAR_CODE=V_REQUEST.INITIATOR.CARDCODE;
                    EXCEPTION
                        WHEN OTHERS
                        THEN
                        NULL;
            END;
            COMMIT;
        ELSE
            FOR L_INDEX IN V_REQUEST.COUNTRYS.FIRST..V_REQUEST.COUNTRYS.LAST
            LOOP

                BEGIN
                    SELECT COUNT(*)
                    INTO V_RESTRICTED
                    FROM COUNTRY
                    WHERE COU_CODE=V_REQUEST.COUNTRYS(L_INDEX).COUNTRYCODE;
                        EXCEPTION
                                WHEN OTHERS
                                THEN
                                V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90022_C;
                                V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90022_D;
                                RETURN ERROR;
                END;

                BEGIN
                    SELECT COUNT(*)
                    INTO V_RESTRICTED
                    FROM COUNTRIES_ACCEPTED
                    WHERE COA_CAR_CODE = V_REQUEST.INITIATOR.CARDCODE
                    AND COA_COU_CODE = V_REQUEST.COUNTRYS(L_INDEX).COUNTRYCODE;
                        EXCEPTION
                                WHEN OTHERS
                                THEN
                                V_RESTRICTED := 0;
                END;

                IF(V_RESTRICTED=0)
                THEN
                    BEGIN
                        INSERT INTO COUNTRIES_ACCEPTED (COA_COU_CODE, COA_CAR_CODE, COA_USR_TYPE,COA_USE_CODE,COA_DATE)
                            VALUES ( V_REQUEST.COUNTRYS(L_INDEX).COUNTRYCODE,V_REQUEST.INITIATOR.CARDCODE,'MOBILE',NULL,SYSDATE);
                    EXCEPTION
                        WHEN OTHERS
                        THEN
                        NULL;
                    END;
                END IF;
                COMMIT;
            END LOOP;
        END IF;



    V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
    V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

    RETURN OK;

    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P21: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSCOUNTRYCHANGE',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSCOUNTRYCHANGE;

    FUNCTION PROCESSBALANCE (
        V_REQUEST    IN OUT NOCOPY BALANCERQ,
        V_RESPONSE   IN OUT NOCOPY BALANCERS)
        RETURN NUMBER
    IS
        RET               NUMBER;

      MERCHANTNBR       VARCHAR2(15) := '999999000000001';
      CARDNBR           VARCHAR2(19);
      CARDEXPIRYDATE    VARCHAR2(4)  := '2202';
      AMOUNT            VARCHAR2(15) := '000000000000';
      ACTUALAMOUNT      VARCHAR2(24) := '000000000345000000000000';
      CURR              VARCHAR2(3)  := '504';
      CVC2              VARCHAR2(3)  := '123';

      PROCCODE          VARCHAR2(6)  := '310000';
      MCC               VARCHAR2(4)  := '5272';
      ACQCTRYCODE       VARCHAR2(3)  := '504';
      SCRUSERNAME       VARCHAR2(29) := 'MOBILE';
      SCRSVRPID         VARCHAR2(10) := '16566';
      RETREFNBR         VARCHAR2(12) := '550000546800';
      ORIGINALDATA      VARCHAR2(42) := '110054682211111111110000000032100000000333';
      AUTHNBR           VARCHAR2(6)  := '111111';
      RESPCODE          VARCHAR2(3);
      RESPMSG           VARCHAR2(40);
      AVAILABLEAMOUNT   VARCHAR2(15);
      F54               VARCHAR2(40);
      SPID              VARCHAR2(10);
      INTERFACES_ROW    INTERFACES%ROWTYPE;
      P_INTERNAL_STAN   VARCHAR2(6);
      P_ACCOUNT_ROW     ACCOUNT%ROWTYPE;
      P_ACC_OVER_LINE_AMOU ACCOUNT.ACC_OVER_LINE_AMOU%TYPE;
   BEGIN


    INSERT_TRACKING (270955,'PROCESSBALANCE..REQUESTID = '||V_REQUEST.INITIATOR.REQUESTID,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE..CLIENTID = '||V_REQUEST.INITIATOR.CLIENTID,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE..ACOUNTNBR = '||V_REQUEST.INITIATOR.ACOUNTNBR,0,0);


    BEGIN
        SELECT CAR_NUMB
           INTO CARDNBR
           FROM CARD
           WHERE CAR_CODE = V_REQUEST.INITIATOR.CARDCODE;
        EXCEPTION WHEN OTHERS THEN
          V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90007_C;
          V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90007_D;
          RETURN NOK;
    END;
          /*
    BEGIN
        SELECT *
            INTO INTERFACES_ROW
            FROM INTERFACES
            WHERE INT_CODE = 3;
        EXCEPTION
        WHEN OTHERS THEN
          V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90033_C;
          V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90033_D;
          RETURN NOK;
    END;

     SPID := INTERFACES_ROW.INT_PID;
     SCRSVRPID := SPID;

     RET := GET_INTERNAL_STAN( P_INTERNAL_STAN );
     IF RET <> 1 THEN
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90034_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90034_D;
        RETURN NOK;
     END IF;

     RETREFNBR := GET_JULIAN_DATE(SYSDATE)||TO_CHAR(SYSDATE, 'HH24')||P_INTERNAL_STAN;


    RET := FUNCTION_IP_TO_WATCH.REQAUTHORIZATION_IP (  'N',--REPEAT_AUTH_FLAG
                                    MERCHANTNBR,
                                    CARDNBR,
                                    PROCCODE,
                                    CARDEXPIRYDATE,
                                    AMOUNT,
                                    CURR,
                                    NULL, --CVC2,
                                    0,--CVC2_IND
                                    MCC,
                                    ACQCTRYCODE,
                                    SCRUSERNAME,
                                    SCRSVRPID,
                                    RETREFNBR,
                                    RESPCODE,
                                    RESPMSG,
                                    AUTHNBR,
                                    AVAILABLEAMOUNT,
                                    F54);

    INSERT_TRACKING (270955,'PROCESSBALANCE...RET = '||RET,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...RESPCODE = '||RESPCODE,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...RESPMSG = '||RESPMSG,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...AUTHNBR = '||AUTHNBR,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...AVAILABLEAMOUNT = '||AVAILABLEAMOUNT,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...F54 = '||F54,0,0);

     IF RET <> 0 THEN
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90035_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90035_D||RESPCODE;
        RETURN NOK;
     END IF;

    CASE RESPCODE
    WHEN '000' THEN V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;

        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        V_RESPONSE.BALANCE := BALANCESTRUCT (   TO_NUMBER(SUBSTR(F54,9,12)/100),
                                         TO_NUMBER(SUBSTR(F54,9+20,12)/100),
                                         37,
                                         'XOF',
                                         SUBSTR(F54,8,1),
                                         SUBSTR(F54,8+20,1),
                                         RETREFNBR);

        RETURN OK;

    ELSE

        BEGIN
            SELECT CRE_LABE INTO V_RESPONSE.STATUS.ERRORDESC
                FROM CODE_RESPONSE_F039
            WHERE CRE_CODE = RESPCODE;
            EXCEPTION WHEN OTHERS
            THEN
            V_RESPONSE.STATUS.ERRORDESC := NULL;
        END;

        V_RESPONSE.STATUS.ERRORCODE := '00'||RESPCODE;

        RETURN NOK;
    END CASE;
*/


    BEGIN
        SELECT *
            INTO P_ACCOUNT_ROW
            FROM ACCOUNT
        WHERE ACC_NUMB=V_REQUEST.INITIATOR.ACOUNTNBR;
        EXCEPTION WHEN OTHERS
            THEN
              V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90006_C;
              V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90006_D;
              RETURN NOK;
    END;

     V_RESPONSE.BALANCE :=
                BALANCESTRUCT (NULL,NULL,NULL,NULL,NULL,NULL,NULL);

            IF(P_ACCOUNT_ROW.ACC_AVAI_AMOU<0)
            THEN
                V_RESPONSE.BALANCE.ACTUAL := (P_ACCOUNT_ROW.ACC_AVAI_AMOU*-1)/100;
                V_RESPONSE.BALANCE.TYPEACTUAL := 0;
            ELSE
                V_RESPONSE.BALANCE.ACTUAL := (P_ACCOUNT_ROW.ACC_AVAI_AMOU)/100;
                V_RESPONSE.BALANCE.TYPEACTUAL := 1;
            END IF;

            P_ACC_OVER_LINE_AMOU := P_ACCOUNT_ROW.ACC_AVAI_AMOU+NVL(P_ACCOUNT_ROW.ACC_OVER_LINE_AMOU,0);
            IF(P_ACC_OVER_LINE_AMOU<0)
            THEN
                V_RESPONSE.BALANCE.AVAILABLE := (P_ACC_OVER_LINE_AMOU*-1)/100;
                V_RESPONSE.BALANCE.TYPEAVAILABLE := 0;
            ELSE
                V_RESPONSE.BALANCE.AVAILABLE := (P_ACC_OVER_LINE_AMOU)/100;
                V_RESPONSE.BALANCE.TYPEAVAILABLE := 1;
            END IF;


            BEGIN
                SELECT CUR_ALPH_CODE,CUR_IDE
                INTO V_RESPONSE.BALANCE.currency,V_RESPONSE.BALANCE.currencycode
                FROM CURRENCY
                WHERE CUR_CODE=P_ACCOUNT_ROW.ACC_CURR_CODE;
            EXCEPTION
            WHEN OTHERS
            THEN
                V_RESPONSE.BALANCE.CURRENCYCODE := NULL;
                V_RESPONSE.BALANCE.CURRENCY := NULL;
            END;


    V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
    V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;


    RETURN OK;


    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P22: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSBALANCE',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSBALANCE;

    FUNCTION PROCESSMINISTAT (
        V_REQUEST    IN OUT NOCOPY MINISTATRQ,
        V_RESPONSE   IN OUT NOCOPY MINISTATRS)
        RETURN NUMBER
    IS
        RET               NUMBER;

      MERCHANTNBR       VARCHAR2(15) := '999999000000001';
      CARDNBR           VARCHAR2(19);
      CARDEXPIRYDATE    VARCHAR2(4)  := '2202';
      AMOUNT            VARCHAR2(15) := '000000000000';
      ACTUALAMOUNT      VARCHAR2(24) := '000000000345000000000000';
      CURR              VARCHAR2(3)  := '504';
      CVC2              VARCHAR2(3)  := '123';

      PROCCODE          VARCHAR2(6)  := '310000';
      MCC               VARCHAR2(4)  := '5272';
      ACQCTRYCODE       VARCHAR2(3)  := '504';
      SCRUSERNAME       VARCHAR2(29) := 'MOBILE';
      SCRSVRPID         VARCHAR2(10) := '16566';
      RETREFNBR         VARCHAR2(12) := '550000546800';
      ORIGINALDATA      VARCHAR2(42) := '110054682211111111110000000032100000000333';
      AUTHNBR           VARCHAR2(6)  := '111111';
      RESPCODE          VARCHAR2(3);
      RESPMSG           VARCHAR2(40);
      AVAILABLEAMOUNT   VARCHAR2(15);
      F54               VARCHAR2(40);
      SPID              VARCHAR2(10);
      INTERFACES_ROW    INTERFACES%ROWTYPE;
      P_INTERNAL_STAN   VARCHAR2(6);
      P_ACCOUNT_ROW     ACCOUNT%ROWTYPE;
      P_ACC_OVER_LINE_AMOU ACCOUNT.ACC_OVER_LINE_AMOU%TYPE;
      V_REQREG   TRANSACTIONSLISTRQ;
      V_RESREG   TRANSACTIONSLISTRS;
   BEGIN


    INSERT_TRACKING (270955,'PROCESSMINISTAT..REQUESTID = '||V_REQUEST.INITIATOR.REQUESTID,0,0);
    INSERT_TRACKING (270955,'PROCESSMINISTAT..CLIENTID = '||V_REQUEST.INITIATOR.CLIENTID,0,0);
    INSERT_TRACKING (270955,'PROCESSMINISTAT..ACOUNTNBR = '||V_REQUEST.INITIATOR.ACOUNTNBR,0,0);


    BEGIN
        SELECT CAR_NUMB
           INTO CARDNBR
           FROM CARD
           WHERE CAR_CODE = V_REQUEST.INITIATOR.CARDCODE;
        EXCEPTION WHEN OTHERS THEN
          V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90007_C;
          V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90007_D;
          RETURN NOK;
    END;
          /*
    BEGIN
        SELECT *
            INTO INTERFACES_ROW
            FROM INTERFACES
            WHERE INT_CODE = 3;
        EXCEPTION
        WHEN OTHERS THEN
          V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90033_C;
          V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90033_D;
          RETURN NOK;
    END;

     SPID := INTERFACES_ROW.INT_PID;
     SCRSVRPID := SPID;

     RET := GET_INTERNAL_STAN( P_INTERNAL_STAN );
     IF RET <> 1 THEN
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90034_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90034_D;
        RETURN NOK;
     END IF;

     RETREFNBR := GET_JULIAN_DATE(SYSDATE)||TO_CHAR(SYSDATE, 'HH24')||P_INTERNAL_STAN;


    RET := FUNCTION_IP_TO_WATCH.REQAUTHORIZATION_IP (  'N',--REPEAT_AUTH_FLAG
                                    MERCHANTNBR,
                                    CARDNBR,
                                    PROCCODE,
                                    CARDEXPIRYDATE,
                                    AMOUNT,
                                    CURR,
                                    NULL, --CVC2,
                                    0,--CVC2_IND
                                    MCC,
                                    ACQCTRYCODE,
                                    SCRUSERNAME,
                                    SCRSVRPID,
                                    RETREFNBR,
                                    RESPCODE,
                                    RESPMSG,
                                    AUTHNBR,
                                    AVAILABLEAMOUNT,
                                    F54);

    INSERT_TRACKING (270955,'PROCESSMINISTAT...RET = '||RET,0,0);
    INSERT_TRACKING (270955,'PROCESSMINISTAT...RESPCODE = '||RESPCODE,0,0);
    INSERT_TRACKING (270955,'PROCESSMINISTAT...RESPMSG = '||RESPMSG,0,0);
    INSERT_TRACKING (270955,'PROCESSMINISTAT...AUTHNBR = '||AUTHNBR,0,0);
    INSERT_TRACKING (270955,'PROCESSMINISTAT...AVAILABLEAMOUNT = '||AVAILABLEAMOUNT,0,0);
    INSERT_TRACKING (270955,'PROCESSMINISTAT...F54 = '||F54,0,0);

     IF RET <> 0 THEN
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90035_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90035_D||RESPCODE;
        RETURN NOK;
     END IF;

    CASE RESPCODE
    WHEN '000' THEN V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;

        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        V_RESPONSE.MINISTAT := MINISTATSTRUCT (   TO_NUMBER(SUBSTR(F54,9,12)/100),
                                         TO_NUMBER(SUBSTR(F54,9+20,12)/100),
                                         37,
                                         'XOF',
                                         SUBSTR(F54,8,1),
                                         SUBSTR(F54,8+20,1),
                                         RETREFNBR);

        RETURN OK;

    ELSE

        BEGIN
            SELECT CRE_LABE INTO V_RESPONSE.STATUS.ERRORDESC
                FROM CODE_RESPONSE_F039
            WHERE CRE_CODE = RESPCODE;
            EXCEPTION WHEN OTHERS
            THEN
            V_RESPONSE.STATUS.ERRORDESC := NULL;
        END;

        V_RESPONSE.STATUS.ERRORCODE := '00'||RESPCODE;

        RETURN NOK;
    END CASE;
*/

        V_REQREG := TRANSACTIONSLISTRQ(NULL, NULL);
        V_REQREG.INITIATOR := INITIATOR2RQ(NULL, NULL, NULL);
        V_REQREG.INITIATOR.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        V_REQREG.INITIATOR.CLIENTID := V_REQUEST.INITIATOR.CLIENTID;
        V_REQREG.INITIATOR.CARDCODE := V_REQUEST.INITIATOR.CARDCODE;
        V_REQREG.FILTER := FILTERSTRUCT (10, NULL, NULL, NULL, NULL);

        V_RESREG := TRANSACTIONSLISTRS (NULL, NULL);
        V_RESREG.STATUS := STATUSSTRUCT (NULL, NULL, NULL);
        V_RESREG.STATUS.REQUESTID := V_REQUEST.INITIATOR.REQUESTID;
        RET := MB_INTERFACE_TOOLS_PKG.PROCESSTRANSACTIONSLIST (V_REQREG,V_RESREG);
        IF RET != MB_INTERFACE_TOOLS_PKG.OK
        THEN
            V_RESPONSE.MINISTAT := NULL;
            V_RESPONSE.STATUS := V_RESREG.STATUS;
            RETURN NOK;
        END IF;

        V_RESPONSE.MINISTAT := V_RESREG.TRANSACTIONS;

    V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
    V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;


    RETURN OK;


    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P23: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSMINISTAT',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSMINISTAT;

    FUNCTION PROCESSPRODUCTSLIST (
        V_REQUEST    IN OUT NOCOPY PRODUCTSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY PRODUCTSLISTRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_COUNT           NUMBER;
        S_COUNT           NUMBER;

    CURSOR FEES_CUR (P_CPR_CODE    CARD_PROGRAM.CPR_CODE%TYPE, P_CMF_CODE    CHLD_MEMBERSHIP_FEES.CMF_CODE%TYPE,
    P_CRF_CODE    CARD_RENEW_FEES.CRF_CODE%TYPE, P_PRF_CODE    PIN_RECALCUL_FEES.PRF_CODE%TYPE,
    P_PFE_CODE    PERSONALIZATION_FEES.PFE_CODE%TYPE)
        IS
        SELECT 1 FEETYPE, CMF_LABE FEELABEL, CMF_AMOU AMOUNT FROM CHLD_MEMBERSHIP_FEES WHERE CMF_CODE=P_CMF_CODE AND CMF_AMOU!=0
        UNION
        SELECT 4 FEETYPE, CRF_LABE FEELABEL, CRF_AMOU AMOUNT FROM CARD_RENEW_FEES WHERE CRF_CODE=P_CRF_CODE AND CRF_AMOU !=0
        UNION
        SELECT 6 FEETYPE, PRF_LABE FEELABEL, PRF_AMOU AMOUNT FROM PIN_RECALCUL_FEES WHERE PRF_CODE=P_PRF_CODE AND PRF_AMOU !=0
        UNION
        SELECT 3 FEETYPE, PFE_LABE FEELABEL, PFE_AMOU AMOUNT  FROM PERSONALIZATION_FEES WHERE PFE_CODE = P_PFE_CODE AND PFE_AMOU !=0
        UNION
        SELECT 5 FEETYPE, CRF_LABE FEELABEL, CRF_AMOU AMOUNT  FROM CARD_REPLACEMENT_FEES WHERE CRF_CODE = (SELECT CPF_CRF_CODE FROM CARD_PROG_REPL_FEES WHERE CPF_CPR_CODE=P_CPR_CODE AND ROWNUM=1) AND CRF_AMOU!=0;

    CURSOR LIMITS_CUR (P_CPR_CODE    CARD_PROGRAM.CPR_CODE%TYPE)
        IS
            SELECT DECODE(IBR_PER_CODE,21,0,3,1,5,2,3) PERIOD, DECODE(IRR_TCO_CODE,'07000',1,0) TRX_TYPE,
                NVL(IRR_TRAN_CUMU_MAX,0) AS MAXAUTHAMOUNT
            FROM CARD_PROGRAM, ISSUER_RISK_PROGRAM, ISSU_BANK_RISK_MANA, ISSU_BANK_RISK_MANA_RECO
            WHERE CPR_CODE = P_CPR_CODE
            AND CPR_IRP_CODE = IRP_CODE
            AND IRP_CODE = IBR_IRP_CODE
            AND IBR_CODE = IRR_IBR_CODE
            AND IRR_TCO_CODE IN ('07000','12000','05000');
    BEGIN


     V_COUNT:=0;
     V_RESPONSE.PRODUCTS := NULL;
     V_RESPONSE.PRODUCTS := PRODUCTSRESULT ();

     FOR CURSOR_ROW IN (SELECT CPR_CODE, CPR_IDEN, CPR_LABE, DECODE(CPR_CTY_CODE,1,1,4,2,3) cpr_type,
     CPR_CMF_CODE, CPR_CRF_CODE,CPR_PRF_CODE,CPR_PFE_CODE FROM CARD_PROGRAM WHERE CPR_BAN_CODE=V_REQUEST.INITIATOR.BANKCODE)
       LOOP
           V_COUNT := V_COUNT + 1;

            V_RESPONSE.PRODUCTS.EXTEND;
            V_RESPONSE.PRODUCTS (V_COUNT) :=
                PRODUCTSTRUCT (NULL,
                                NULL,null,null,null,null);

            V_RESPONSE.PRODUCTS (V_COUNT).productcode:= CURSOR_ROW.CPR_CODE  ;
            V_RESPONSE.PRODUCTS (V_COUNT).productname:= CURSOR_ROW.CPR_IDEN ;
            V_RESPONSE.PRODUCTS (V_COUNT).productdesc:= CURSOR_ROW.CPR_LABE  ;
            V_RESPONSE.PRODUCTS (V_COUNT).producttype:= CURSOR_ROW.cpr_type ;

                ---add fees
              V_RESPONSE.PRODUCTS(V_COUNT).FEES := NULL;
                 V_RESPONSE.PRODUCTS(V_COUNT).FEES := FEESRESULT ();
                 S_COUNT := 0;
                 FOR CURFEE_ROW IN FEES_CUR (CURSOR_ROW.CPR_CODE, CURSOR_ROW.CPR_CMF_CODE,CURSOR_ROW.CPR_CRF_CODE,CURSOR_ROW.CPR_PRF_CODE,CURSOR_ROW.CPR_PFE_CODE)
                 LOOP
                    S_COUNT := S_COUNT + 1;
                    V_RESPONSE.PRODUCTS (V_COUNT).FEES.EXTEND;
                    V_RESPONSE.PRODUCTS (V_COUNT).FEES (S_COUNT) := FEESTRUCT (CURFEE_ROW.FEETYPE,CURFEE_ROW.FEELABEL,CURFEE_ROW.AMOUNT);
                 END LOOP;
                 IF(S_COUNT =0)THEN
                    V_RESPONSE.PRODUCTS (V_COUNT).FEES := NULL;
                 END IF;

                 V_RESPONSE.PRODUCTS(V_COUNT).LIMITS := NULL;
                 V_RESPONSE.PRODUCTS(V_COUNT).LIMITS := LIMITSRESULT ();
                 S_COUNT := 0;
                FOR CURLIMIT_ROW IN LIMITS_CUR (CURSOR_ROW.CPR_CODE)
                LOOP
                  S_COUNT := S_COUNT + 1;
                    V_RESPONSE.PRODUCTS(V_COUNT).LIMITS.EXTEND;
                    V_RESPONSE.PRODUCTS(V_COUNT).LIMITS (S_COUNT) :=LIMITSTRUCT (NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL);
                    V_RESPONSE.PRODUCTS(V_COUNT).LIMITS (S_COUNT).TRXTYPE := CURLIMIT_ROW.TRX_TYPE;
                    V_RESPONSE.PRODUCTS(V_COUNT).LIMITS (S_COUNT).PERIOD := CURLIMIT_ROW.PERIOD;
                    V_RESPONSE.PRODUCTS(V_COUNT).LIMITS (S_COUNT).CURRENCYISO := 952;
                    V_RESPONSE.PRODUCTS(V_COUNT).LIMITS (S_COUNT).CURRENCY := 'XOF';
                    V_RESPONSE.PRODUCTS(V_COUNT).LIMITS (S_COUNT).maxperamountcrd := -1;
                    V_RESPONSE.PRODUCTS(V_COUNT).LIMITS (S_COUNT).MAXPERAMOUNTPRD := CURLIMIT_ROW.MAXAUTHAMOUNT;
                END LOOP;
                 IF(S_COUNT =0)THEN
                    V_RESPONSE.PRODUCTS (V_COUNT).LIMITS := NULL;
                 END IF;
        END LOOP;

        IF(V_COUNT =0)THEN
            V_RESPONSE.PRODUCTS := NULL;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.PRODUCTS := NULL;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P24: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSPRODUCTSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSPRODUCTSLIST;

    FUNCTION PROCESSCREATECARD (V_REQUEST    IN OUT NOCOPY CREATECARDRQ,
                                V_RESPONSE   IN OUT NOCOPY CREATECARDRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        P_CUSTOMER_TABLE_REC          CUSTOMER_CARDHOLDER%ROWTYPE;
        P_ACCOUNT_TABLE_REC           ACCOUNT%ROWTYPE;
        V_CARD_TABLE_REC              CARD%ROWTYPE;
        V_ADRESS_TABLE_REC            ADDRESS%ROWTYPE;
        V_CARD_PROGRAM_TABLE_REC      CARD_PROGRAM%ROWTYPE;
        V_NATIONALBIN_TABLE_REC       NATIONAL_BIN%ROWTYPE;
        V_ROUTING_TABLE_REC           CARDHOLDER_ROUTING%ROWTYPE;
        V_CARD_ACCOUNT_LINK_REC       CARD_ACCOUNT_LINK%ROWTYPE;
        RESPONSE_CODE                 NUMBER;
        V_CAR_NUMB                    CARD.CAR_NUMB%TYPE;
        V_COUNTER                     NUMBER;
        P_IBR_CODE                    NUMBER;
        P_CCO_CODE                    NUMBER;
        PP_CCO_CODE                   NUMBER;--TEST
        V_COUNT         NUMBER:=0;
        V_TRACE VARCHAR(10);
        V_MOBILE V_ADRESS_TABLE_REC.ADR_FIRS_PHON%TYPE;
        CURSOR CARD_ONLINE_RISK
        IS
            SELECT A.IRP_CODE IRP_CODE,
                   A.IRP_IDEN IRP_IDEN,
                   A.IRP_BAN_CODE IRP_BAN_CODE,
                   B.IBR_CODE IBR_CODE,
                   B.IBR_PER_CODE IBR_PER_CODE,
                   B.IBR_TRAN_MIN IBR_TRAN_MIN,
                   B.IBR_TRAN_MAX IBR_TRAN_MAX,
                   B.IBR_TRAN_CUMU_MAX IBR_TRAN_CUMU_MAX,
                   B.IBR_TRAN_CUMU_NBR IBR_TRAN_CUMU_NBR,
                   B.IBR_BAN_CODE IBR_BAN_CODE,
                   B.IBR_IRP_CODE IBR_IRP_CODE,
                   C.IRR_CODE IRR_CODE,
                   C.IRR_ATY_CODE IRR_ATY_CODE,
                   C.IRR_MAG_CODE IRR_MAG_CODE,
                   C.IRR_PCA_CODE IRR_PCA_CODE,
                   C.IRR_DOM_CODE IRR_DOM_CODE,
                   C.IRR_SLB_CODE IRR_SLB_CODE,
                   C.IRR_TTY_CODE IRR_TTY_CODE,
                   C.IRR_TCO_CODE IRR_TCO_CODE,
                   C.IRR_INTE_MAIL_ORDE IRR_INTE_MAIL_ORDE,
                   C.IRR_TRAN_MIN IRR_TRAN_MIN,
                   C.IRR_TRAN_MAX IRR_TRAN_MAX,
                   C.IRR_TRAN_CUMU_MAX IRR_TRAN_CUMU_MAX,
                   C.IRR_TRAN_CUMU_NBR IRR_TRAN_CUMU_NBR,
                   C.IRR_IBR_CODE IRR_IBR_CODE
              FROM ISSUER_RISK_PROGRAM A,
                   ISSU_BANK_RISK_MANA B,
                   ISSU_BANK_RISK_MANA_RECO C
             WHERE     C.IRR_IBR_CODE = B.IBR_CODE
                   AND B.IBR_IRP_CODE = A.IRP_CODE
                   AND A.IRP_CODE = V_CARD_PROGRAM_TABLE_REC.CPR_IRP_CODE
                   AND A.IRP_BAN_CODE = V_CARD_PROGRAM_TABLE_REC.CPR_BAN_CODE
                   AND B.IBR_BAN_CODE = V_CARD_PROGRAM_TABLE_REC.CPR_BAN_CODE;
   BEGIN


        V_TRACE := 'START ';
        P_CUSTOMER_TABLE_REC := NULL;
        V_TRACE := 'READ CUS ';
        BEGIN
            SELECT *
              INTO P_CUSTOMER_TABLE_REC
              FROM CUSTOMER_CARDHOLDER
             WHERE CUS_IDEN = V_REQUEST.INITIATOR.CLIENTID;
        EXCEPTION
                WHEN OTHERS
                THEN
                V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.WT_90000_C;
                V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.WT_90000_D;
                RETURN ERROR;
        END;

        V_CARD_PROGRAM_TABLE_REC := NULL;
        V_TRACE := 'READ PRG ';
        BEGIN
            SELECT *
              INTO V_CARD_PROGRAM_TABLE_REC
              FROM CARD_PROGRAM
             WHERE CPR_CODE=V_REQUEST.CARD.PRODUCTCODE
             AND CPR_BAN_CODE = P_CUSTOMER_TABLE_REC.CUS_BAN_CODE;
             EXCEPTION
                WHEN OTHERS
                THEN
                V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90024_C;
                V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90024_D;
                RETURN ERROR;
        END;
        IF(V_CARD_PROGRAM_TABLE_REC.CPR_CTY_CODE!=1)
        THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90025_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90025_D;
            RETURN ERROR;
        END IF;

        P_ACCOUNT_TABLE_REC := NULL;
        V_TRACE := 'READ ACC ';
        BEGIN
            SELECT *
              INTO P_ACCOUNT_TABLE_REC
              FROM ACCOUNT
             WHERE ACC_CUS_CODE = P_CUSTOMER_TABLE_REC.CUS_CODE
             AND ACC_CODE = P_CUSTOMER_TABLE_REC.CUS_DEFA_ACC_CODE
             AND ACC_ATY_CODE=1
             AND ROWNUM =1;
        EXCEPTION
            WHEN OTHERS
            THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90006_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90006_D;
            RETURN ERROR;
        END;
        IF(P_ACCOUNT_TABLE_REC.ACC_AST_CODE!=1)
        THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90026_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90026_D;
            RETURN ERROR;
        END IF;

   /*     BEGIN
            SELECT count(*)
              INTO v_count
              FROM CARDHOLDER_ROUTING, CARD
             WHERE CRO_ACC_CODE = P_ACCOUNT_TABLE_REC.ACC_CODE
             AND CRO_PAN = CAR_NUMB
             AND CAR_PRIM_SECO_CARD = 'P'
             AND ROWNUM =1;
        EXCEPTION
            WHEN OTHERS
            THEN
            v_count := 0;
        END;

        IF(v_count>0)
        THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90027_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90027_D;
            RETURN ERROR;
        END IF;
*/

        V_CARD_TABLE_REC := NULL;
        V_CARD_TABLE_REC.CAR_STAR_DATE := SYSDATE;
        V_TRACE := 'ADD_MONTHS';
        BEGIN
            SELECT ADD_MONTHS (
                       V_CARD_TABLE_REC.CAR_STAR_DATE,
                       V_CARD_PROGRAM_TABLE_REC.CPR_LIFE_CYCL * 12)
              INTO V_CARD_TABLE_REC.CAR_EXPI_DATE
              FROM DUAL;
        END;

         V_CARD_TABLE_REC.CAR_PREP_DATE := SYSDATE;
         V_NATIONALBIN_TABLE_REC := NULL;
         V_TRACE := 'NATIO_BIN';
        BEGIN
          SELECT *
            INTO V_NATIONALBIN_TABLE_REC
            FROM NATIONAL_BIN
           WHERE     V_CARD_PROGRAM_TABLE_REC.CPR_PRIM_NBI_IDEN >=
                         NBI_BIN_RANG_MIN
                 AND V_CARD_PROGRAM_TABLE_REC.CPR_PRIM_NBI_IDEN <=
                         NBI_BIN_RANG_MAX;
        END;


        V_TRACE := 'PAN ';
        RET:=CARD_GENERATION_PKG.CARD_NUMBER_GENERATION(P_CUSTOMER_TABLE_REC.CUS_BAN_CODE,P_CUSTOMER_TABLE_REC.CUS_BRA_CODE,
                                                                                                V_CARD_PROGRAM_TABLE_REC.CPR_PRIM_NBI_IDEN,
                                                                                                V_NATIONALBIN_TABLE_REC.NBI_PAN_LENG,
                                                                                                P_CUSTOMER_TABLE_REC.CUS_CODE,
                                                                                                V_CARD_TABLE_REC.CAR_NUMB,
                                                                                                NULL,
                                                                                                RESPONSE_CODE);
         INSERT_TRACKING (270955,'V_CARD_TABLE_REC.CAR_NUMB: '||V_CARD_TABLE_REC.CAR_NUMB,0,0);

        IF(RET!=Cms_Batches_Resp_Code_Pkg.RC_OK OR V_CARD_TABLE_REC.CAR_NUMB=NULL)
        THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90002_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90002_D;
            RETURN ERROR;
        END IF;
           V_TRACE := 'CAR_CODE ';

           SELECT MAX(CAR_CODE)+1 INTO V_CARD_TABLE_REC.CAR_CODE FROM CARD;

            V_CARD_TABLE_REC.CAR_ANON_FLAG := 'N';
            V_CARD_TABLE_REC.CAR_SEQU_NUMB := '001';
            V_CARD_TABLE_REC.CAR_CHLD_TITL := P_CUSTOMER_TABLE_REC.CUS_TIT1;
            V_CARD_TABLE_REC.CAR_CHLD_LAST_NAME := P_CUSTOMER_TABLE_REC.CUS_LAST_NAM1;
            V_CARD_TABLE_REC.CAR_CHLD_FIRS_NAME := P_CUSTOMER_TABLE_REC.CUS_FIRS_NAM1;
            V_CARD_TABLE_REC.CAR_CHLD_NAME := V_REQUEST.CARD.NAMEPRINTED;           --CAR_CHLD_NAME;
            V_CARD_TABLE_REC.CAR_MAGN_FLAG :=
                V_CARD_PROGRAM_TABLE_REC.CPR_MAGN_FLAG;
            V_CARD_TABLE_REC.CAR_CHIP_FLAG :=
                V_CARD_PROGRAM_TABLE_REC.CPR_CHIP_FLAG;
            V_CARD_TABLE_REC.CAR_CPR_CODE := V_CARD_PROGRAM_TABLE_REC.CPR_CODE;
            V_CARD_TABLE_REC.CAR_TRAC1 := V_CARD_PROGRAM_TABLE_REC.CPR_TRAC1;
            V_CARD_TABLE_REC.CAR_TRAC2 := V_CARD_PROGRAM_TABLE_REC.CPR_TRAC2;
            V_CARD_TABLE_REC.CAR_TRAC3 := V_CARD_PROGRAM_TABLE_REC.CPR_TRAC3;
            V_CARD_TABLE_REC.CAR_SERV_CODE_1ST :=
                V_CARD_PROGRAM_TABLE_REC.CPR_SCO_CODE_1ST;
            V_CARD_TABLE_REC.CAR_SERV_CODE_2ND :=
                V_CARD_PROGRAM_TABLE_REC.CPR_SCO_CODE_2ND;
            V_CARD_TABLE_REC.CAR_SERV_CODE_3RD :=
                V_CARD_PROGRAM_TABLE_REC.CPR_SCO_CODE_3RD;
            V_CARD_TABLE_REC.CAR_PIN_TRY_LIMI :=
                V_CARD_PROGRAM_TABLE_REC.CPR_PIN_TRY_LIMI;
            V_CARD_TABLE_REC.CAR_LIFE_CYCL :=
                V_CARD_PROGRAM_TABLE_REC.CPR_LIFE_CYCL;
            V_CARD_TABLE_REC.CAR_FIRS_CREA_DATE := SYSDATE;
            V_CARD_TABLE_REC.CAR_PIN_GENE :=
                V_CARD_PROGRAM_TABLE_REC.CPR_RENE_PIN_GENE;
            V_CARD_TABLE_REC.CAR_CARD_AUTO_RENE :=
                V_CARD_PROGRAM_TABLE_REC.CPR_CARD_AUTO_RENE;
            V_CARD_TABLE_REC.CAR_PRIM_SECO_CARD := 'P';  --CAR_PRIM_SECO_CARD;
            V_CARD_TABLE_REC.CAR_PRIM_CAR_CODE := NULL;
            V_CARD_TABLE_REC.CAR_CTY_CODE :=
                V_CARD_PROGRAM_TABLE_REC.CPR_CTY_CODE;
            V_CARD_TABLE_REC.CAR_CUS_CODE := P_CUSTOMER_TABLE_REC.CUS_CODE;
            V_CARD_TABLE_REC.CAR_CST_CODE := NULL;
            V_CARD_TABLE_REC.CAR_RENE_CRS_CODE := 3;
            V_CARD_TABLE_REC.CAR_CPE_CODE := 2;
            V_CARD_TABLE_REC.CAR_REPL_CPS_CODE := 3;
            V_CARD_TABLE_REC.CAR_CMF_CODE := NULL;
            V_CARD_TABLE_REC.CAR_CMF_CALC_DATE := SYSDATE;
            V_CARD_TABLE_REC.CAR_CRF_CODE :=
                V_CARD_PROGRAM_TABLE_REC.CPR_CRF_CODE;
            V_CARD_TABLE_REC.CAR_PRF_CODE :=
                V_CARD_PROGRAM_TABLE_REC.CPR_PRF_CODE;
            V_CARD_TABLE_REC.CAR_PFE_CODE := NULL;
            V_CARD_TABLE_REC.CAR_INTE_ORDE :=
                V_CARD_PROGRAM_TABLE_REC.CPR_INTE_ORDE;
            V_CARD_TABLE_REC.CAR_MAIL_ORDE :=
                V_CARD_PROGRAM_TABLE_REC.CPR_MAIL_ORDE;
            V_CARD_TABLE_REC.CAR_NEW_CARD_DESI := NULL;
            V_CARD_TABLE_REC.CAR_STAT_DATE := SYSDATE;
            V_CARD_TABLE_REC.CAR_COM_CODE :=
                V_CARD_PROGRAM_TABLE_REC.CPR_COM_CODE;
            V_CARD_TABLE_REC.CAR_COM_EFFE_DATE :=
                V_CARD_TABLE_REC.CAR_STAR_DATE;
            V_CARD_TABLE_REC.CAR_COM_ONLI_OFFL :=
                V_CARD_PROGRAM_TABLE_REC.CPR_COM_ONLI_OFFL;
            V_CARD_TABLE_REC.CAR_PME_CODE := 1;
            V_CARD_TABLE_REC.CAR_BAN_CODE := P_CUSTOMER_TABLE_REC.CUS_BAN_CODE;
            V_CARD_TABLE_REC.CAR_BRA_CODE := P_CUSTOMER_TABLE_REC.CUS_BRA_CODE;
            V_TRACE := 'CARD';

            INSERT INTO CARD  VALUES V_CARD_TABLE_REC;


            BEGIN
                V_ADRESS_TABLE_REC := NULL;
                V_TRACE := 'ADR_CODE ';
                INCREMENTE_CODE ('ADDRESS', 'ADR_CODE', V_ADRESS_TABLE_REC.ADR_CODE);
                INSERT_TRACKING (270955,'V_ADRESS_TABLE_REC.ADR_CODE: '||V_ADRESS_TABLE_REC.ADR_CODE,0,0);
                V_ADRESS_TABLE_REC.ADR_ADR1 := NVL(V_REQUEST.CARD.ADDR1,'NO FILL FROM MOBILE');
                V_ADRESS_TABLE_REC.ADR_ADR2 := NVL(V_REQUEST.CARD.ADDR1,'NO FILL FROM MOBILE');
                V_ADRESS_TABLE_REC.ADR_ADRE_STRE := NULL;
                V_ADRESS_TABLE_REC.ADR_ADRE_STAT := NULL;
                V_ADRESS_TABLE_REC.ADR_ADRE_ZIPD := NULL;
                V_ADRESS_TABLE_REC.ADR_ADRE_POBX := NULL;
                V_ADRESS_TABLE_REC.ADR_CITY_CODE :=NULL;
                V_ADRESS_TABLE_REC.ADR_PHO1 := V_REQUEST.CARD.PHONENUM;
                V_ADRESS_TABLE_REC.ADR_PHO2 := NULL;
                V_ADRESS_TABLE_REC.ADR_FAX := NULL;
                V_ADRESS_TABLE_REC.ADR_FIRS_FIRS_NAME := P_CUSTOMER_TABLE_REC.CUS_FIRS_NAM1;
                V_ADRESS_TABLE_REC.ADR_FIRS_LAST_NAME := P_CUSTOMER_TABLE_REC.CUS_LAST_NAM1;
                V_ADRESS_TABLE_REC.ADR_FIRS_FUNC := NULL;
                V_ADRESS_TABLE_REC.ADR_FIRS_PHON := V_REQUEST.CARD.PHONENUM;
                V_ADRESS_TABLE_REC.ADR_FIRS_MAIL := NULL;
                V_ADRESS_TABLE_REC.ADR_ATY_CODE := 2;
                V_ADRESS_TABLE_REC.ADR_CAR_CODE := V_CARD_TABLE_REC.CAR_CODE;
                V_ADRESS_TABLE_REC.ADR_TYPE := 'CARDHOLDER';
                V_TRACE := 'ADDRESS ';
                INSERT INTO ADDRESS VALUES V_ADRESS_TABLE_REC;
            EXCEPTION
                WHEN OTHERS
                THEN
                NULL;
            END;

        V_TRACE := 'CORR_TYPE ';
        BEGIN
            INSERT INTO CUST_ADDR_TYPE_CORR_TYPE (CAT_CUS_CODE, CAT_CTY_CODE, CAT_ATY_CODE)
                VALUES ( P_CUSTOMER_TABLE_REC.CUS_CODE,1,2);
        EXCEPTION
            WHEN OTHERS
            THEN
            NULL;
        END;

        V_TRACE := 'RISK ';
            P_IBR_CODE := 0;
            FOR CARD_ONLINE_RISK_ROW IN CARD_ONLINE_RISK
            LOOP
                BEGIN
                    IF (P_IBR_CODE <> CARD_ONLINE_RISK_ROW.IBR_CODE)
                    THEN
                        BEGIN
                            P_IBR_CODE := CARD_ONLINE_RISK_ROW.IBR_CODE;
                            V_TRACE := 'CCO_CODE';
                            INCREMENTE_CODE ('CUST_CHLD_ONLI_RISK',
                                             'CCO_CODE',
                                             P_CCO_CODE);
                          V_TRACE := 'CHLD_ONLI';
                            INSERT
                              INTO CUST_CHLD_ONLI_RISK (CCO_CODE,
                                                        CCO_PER_CODE,
                                                        CCO_TRAN_MIN,
                                                        CCO_TRAN_MAX,
                                                        CCO_TRAN_CUMU_MAX,
                                                        CCO_TRAN_CUMU_NBR,
                                                        CCO_CAR_CODE)
                            VALUES (P_CCO_CODE,
                                    CARD_ONLINE_RISK_ROW.IBR_PER_CODE,
                                    CARD_ONLINE_RISK_ROW.IBR_TRAN_MIN,
                                    CARD_ONLINE_RISK_ROW.IBR_TRAN_MAX,
                                    CARD_ONLINE_RISK_ROW.IBR_TRAN_CUMU_MAX,
                                    CARD_ONLINE_RISK_ROW.IBR_TRAN_CUMU_NBR,
                                    V_CARD_TABLE_REC.CAR_CODE);
                        END;
                    END IF;

                    V_TRACE := 'CCO_CODE';
                    INCREMENTE_CODE ('CUST_CHLD_ONLI_RISK_RECO',
                                     'CCO_CODE',
                                     PP_CCO_CODE);
                   V_TRACE := 'RICO';
                    INSERT INTO CUST_CHLD_ONLI_RISK_RECO (CCO_CODE,
                                                          CCO_ATY_CODE,
                                                          CCO_MAG_CODE,
                                                          CCO_PCA_CODE,
                                                          CCO_DOM_CODE,
                                                          CCO_SLB_CODE,
                                                          CCO_TTY_CODE,
                                                          CCO_TCO_CODE,
                                                          CCO_INTE_MAIL_ORDE,
                                                          CCO_TRAN_MIN,
                                                          CCO_TRAN_MAX,
                                                          CCO_TRAN_CUMU_MAX,
                                                          CCO_TRAN_CUMU_NBR,
                                                          CCO_CCO_CODE)
                    VALUES (PP_CCO_CODE,
                            CARD_ONLINE_RISK_ROW.IRR_ATY_CODE,
                            CARD_ONLINE_RISK_ROW.IRR_MAG_CODE,
                            CARD_ONLINE_RISK_ROW.IRR_PCA_CODE,
                            CARD_ONLINE_RISK_ROW.IRR_DOM_CODE,
                            CARD_ONLINE_RISK_ROW.IRR_SLB_CODE,
                            CARD_ONLINE_RISK_ROW.IRR_TTY_CODE,
                            CARD_ONLINE_RISK_ROW.IRR_TCO_CODE,
                            CARD_ONLINE_RISK_ROW.IRR_INTE_MAIL_ORDE,
                            CARD_ONLINE_RISK_ROW.IRR_TRAN_MIN,
                            CARD_ONLINE_RISK_ROW.IRR_TRAN_MAX,
                            CARD_ONLINE_RISK_ROW.IRR_TRAN_CUMU_MAX,
                            CARD_ONLINE_RISK_ROW.IRR_TRAN_CUMU_NBR,
                            P_CCO_CODE);
                        END;
            END LOOP;

            SELECT MAX(CRO_CODE)+1 INTO V_ROUTING_TABLE_REC.CRO_CODE FROM CARDHOLDER_ROUTING;
            V_ROUTING_TABLE_REC.CRO_TRAN_CURR_CODE := NULL;
            V_ROUTING_TABLE_REC.CRO_AID := NULL;
            V_ROUTING_TABLE_REC.CRO_PAN := V_CARD_TABLE_REC.CAR_NUMB;
            V_ROUTING_TABLE_REC.CRO_TRAN_CODE := NULL;
            V_ROUTING_TABLE_REC.CRO_TRAN_MCC := NULL;
            V_ROUTING_TABLE_REC.CRO_CUS_CODE := P_CUSTOMER_TABLE_REC.CUS_CODE;
            V_ROUTING_TABLE_REC.CRO_ACC_CODE := P_ACCOUNT_TABLE_REC.ACC_CODE;
            V_TRACE := 'ROUTING';
            BEGIN
                INSERT INTO CARDHOLDER_ROUTING VALUES V_ROUTING_TABLE_REC ;
           END;

                SELECT MAX(CAL_CODE)+1 INTO V_CARD_ACCOUNT_LINK_REC.CAL_CODE FROM CARD_ACCOUNT_LINK;

            V_CARD_ACCOUNT_LINK_REC.CAL_ACC_CODE := P_ACCOUNT_TABLE_REC.ACC_CODE;
            V_CARD_ACCOUNT_LINK_REC.CAL_PAN := V_CARD_TABLE_REC.CAR_NUMB;
            V_CARD_ACCOUNT_LINK_REC.CAL_CUS_CODE := P_CUSTOMER_TABLE_REC.CUS_CODE;
            V_CARD_ACCOUNT_LINK_REC.CAL_CHEQ_BOOK_FLAG := NULL;
            V_TRACE := 'LINK';
           BEGIN
                INSERT INTO CARD_ACCOUNT_LINK VALUES V_CARD_ACCOUNT_LINK_REC;
           END;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := V_TRACE||SUBSTR (SQLERRM, 1,70);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSCREATECARD',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSCREATECARD;


    FUNCTION PROCESSSECONDCARD (V_REQUEST    IN OUT NOCOPY SECONDCARDRQ,
                                V_RESPONSE   IN OUT NOCOPY SECONDCARDRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        P_CUSTOMER_TABLE_REC          CUSTOMER_CARDHOLDER%ROWTYPE;
        P_ACCOUNT_TABLE_REC           ACCOUNT%ROWTYPE;
        V_CARD_TABLE_REC              CARD%ROWTYPE;
        V_ADR_CODE                    ADDRESS.ADR_CODE%TYPE;
        V_CARD_PROGRAM_TABLE_REC      CARD_PROGRAM%ROWTYPE;
        V_NATIONALBIN_TABLE_REC       NATIONAL_BIN%ROWTYPE;
        V_ROUTING_TABLE_REC           CARDHOLDER_ROUTING%ROWTYPE;
        V_CARD_ACCOUNT_LINK_REC       CARD_ACCOUNT_LINK%ROWTYPE;
        RESPONSE_CODE                 NUMBER;
        V_CAR_NUMB                    CARD.CAR_NUMB%TYPE;
        V_CAR_CODE                    CARD.CAR_CODE%TYPE;
        V_COUNTER                     NUMBER;
        P_IBR_CODE                    NUMBER;
        P_CCO_CODE                    NUMBER;
        PP_CCO_CODE                   NUMBER;--TEST
        V_COUNT         NUMBER:=0;
        V_TRACE VARCHAR(10);
   BEGIN

        V_TRACE := 'START ';
        P_CUSTOMER_TABLE_REC := NULL;
        V_TRACE := 'READ CUS ';
        BEGIN
            SELECT *
              INTO P_CUSTOMER_TABLE_REC
              FROM CUSTOMER_CARDHOLDER
             WHERE CUS_IDEN = V_REQUEST.INITIATOR.CLIENTID;
        EXCEPTION
                WHEN OTHERS
                THEN
                V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.WT_90000_C;
                V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.WT_90000_D;
                RETURN ERROR;
        END;

        V_CARD_TABLE_REC := NULL;
        V_TRACE := 'READ CRD ';
        BEGIN
            SELECT *
              INTO V_CARD_TABLE_REC
              FROM CARD
             WHERE CAR_CODE = V_REQUEST.INITIATOR.CARDCODE;
        EXCEPTION
                WHEN OTHERS
                THEN
                V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90007_C;
                V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90007_D;
                RETURN ERROR;
        END;

        V_CAR_NUMB :=  V_CARD_TABLE_REC.CAR_NUMB;
        V_CAR_CODE :=  V_CARD_TABLE_REC.CAR_CODE;

        IF(V_CARD_TABLE_REC.CAR_CTY_CODE!=1)
        THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90028_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90028_D;
            RETURN ERROR;
        END IF;

        V_CARD_PROGRAM_TABLE_REC := NULL;
        V_TRACE := 'READ PRG ';
        BEGIN
            SELECT *
              INTO V_CARD_PROGRAM_TABLE_REC
              FROM CARD_PROGRAM
             WHERE CPR_CODE=V_CARD_TABLE_REC.CAR_CPR_CODE;
             EXCEPTION
                WHEN OTHERS
                THEN
                V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90024_C;
                V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90024_D;
                RETURN ERROR;
        END;

        V_CARD_TABLE_REC.CAR_STAR_DATE := SYSDATE;
        V_TRACE := 'ADD_MONTHS';
        BEGIN
            SELECT ADD_MONTHS (
                       V_CARD_TABLE_REC.CAR_STAR_DATE,
                       V_CARD_PROGRAM_TABLE_REC.CPR_LIFE_CYCL * 12)
              INTO V_CARD_TABLE_REC.CAR_EXPI_DATE
              FROM DUAL;
        END;

         V_CARD_TABLE_REC.CAR_PREP_DATE := SYSDATE;
         V_NATIONALBIN_TABLE_REC := NULL;
         V_TRACE := 'NATIO_BIN';
        BEGIN
          SELECT *
            INTO V_NATIONALBIN_TABLE_REC
            FROM NATIONAL_BIN
           WHERE     V_CARD_PROGRAM_TABLE_REC.CPR_PRIM_NBI_IDEN >=
                         NBI_BIN_RANG_MIN
                 AND V_CARD_PROGRAM_TABLE_REC.CPR_PRIM_NBI_IDEN <=
                         NBI_BIN_RANG_MAX;
        END;

        V_TRACE := 'PAN ';
        RET:=CARD_GENERATION_PKG.CARD_NUMBER_GENERATION(P_CUSTOMER_TABLE_REC.CUS_BAN_CODE,P_CUSTOMER_TABLE_REC.CUS_BRA_CODE,
                                                                                                V_CARD_PROGRAM_TABLE_REC.CPR_PRIM_NBI_IDEN,
                                                                                                V_NATIONALBIN_TABLE_REC.NBI_PAN_LENG,
                                                                                                P_CUSTOMER_TABLE_REC.CUS_CODE,
                                                                                                V_CARD_TABLE_REC.CAR_NUMB,
                                                                                                NULL,
                                                                                                RESPONSE_CODE);
         INSERT_TRACKING (270955,'V_CARD_TABLE_REC.CAR_NUMB: '||V_CARD_TABLE_REC.CAR_NUMB,0,0);

        IF(RET!=Cms_Batches_Resp_Code_Pkg.RC_OK OR V_CARD_TABLE_REC.CAR_NUMB=NULL)
        THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90002_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90002_D;
            RETURN ERROR;
        END IF;
           V_TRACE := 'CAR_CODE ';
            SELECT MAX(CAR_CODE)+1 INTO V_CARD_TABLE_REC.CAR_CODE FROM CARD;

            V_CARD_TABLE_REC.CAR_CHLD_NAME := V_REQUEST.CARD.NAMEPRINTED;           --CAR_CHLD_NAME;
            V_CARD_TABLE_REC.CAR_FIRS_CREA_DATE := SYSDATE;
            V_CARD_TABLE_REC.CAR_PRIM_SECO_CARD := 'S';  --CAR_PRIM_SECO_CARD;
            V_CARD_TABLE_REC.CAR_PRIM_CAR_CODE := V_CAR_CODE;
            V_CARD_TABLE_REC.CAR_CUS_CODE := P_CUSTOMER_TABLE_REC.CUS_CODE;
            V_CARD_TABLE_REC.CAR_CST_CODE := NULL;
            V_CARD_TABLE_REC.CAR_RENE_CRS_CODE := 3;
            V_CARD_TABLE_REC.CAR_CPE_CODE := 2;
            V_CARD_TABLE_REC.CAR_REPL_CPS_CODE := 3;
            V_CARD_TABLE_REC.CAR_CMF_CODE := NULL;
            V_CARD_TABLE_REC.CAR_CMF_CALC_DATE := SYSDATE;
            V_CARD_TABLE_REC.CAR_PFE_CODE := NULL;
            V_CARD_TABLE_REC.CAR_NEW_CARD_DESI := NULL;
            V_CARD_TABLE_REC.CAR_STAT_DATE := SYSDATE;
            V_CARD_TABLE_REC.CAR_COM_EFFE_DATE := V_CARD_TABLE_REC.CAR_STAR_DATE;
            V_CARD_TABLE_REC.CAR_PME_CODE := 1;
            V_CARD_TABLE_REC.CAR_BAN_CODE := P_CUSTOMER_TABLE_REC.CUS_BAN_CODE;
            V_CARD_TABLE_REC.CAR_BRA_CODE := P_CUSTOMER_TABLE_REC.CUS_BRA_CODE;

            V_TRACE := 'CARD';
            INSERT INTO CARD VALUES V_CARD_TABLE_REC ;
            BEGIN
                INCREMENTE_CODE ('ADDRESS', 'ADR_CODE', V_ADR_CODE);
                V_TRACE := 'ADDRESS ';
                INSERT INTO ADDRESS (ADR_CODE,
                                     ADR_ADR1,
                                     ADR_ADR2,
                                     ADR_ADRE_STRE,
                                     ADR_ADRE_STAT,
                                     ADR_ADRE_ZIPD,
                                     ADR_ADRE_POBX,
                                     ADR_CITY_CODE,
                                     ADR_PHO1,
                                     ADR_PHO2,
                                     ADR_FAX,
                                     ADR_FIRS_FIRS_NAME,
                                     ADR_FIRS_LAST_NAME,
                                     ADR_FIRS_FUNC,
                                     ADR_FIRS_PHON,
                                     ADR_FIRS_MAIL,
                                     ADR_ATY_CODE,
                                     ADR_CAR_CODE,
                                     ADR_TYPE)
                SELECT V_ADR_CODE,
                         ADR_ADR1,
                         ADR_ADR2,
                         ADR_ADRE_STRE,
                         ADR_ADRE_STAT,
                         ADR_ADRE_ZIPD,
                         ADR_ADRE_POBX,
                         ADR_CITY_CODE,
                         ADR_PHO1,
                         ADR_PHO2,
                         ADR_FAX,
                         ADR_FIRS_FIRS_NAME,
                         ADR_FIRS_LAST_NAME,
                         ADR_FIRS_FUNC,
                         ADR_FIRS_PHON,
                         ADR_FIRS_MAIL,
                         ADR_ATY_CODE,
                         V_CARD_TABLE_REC.CAR_CODE,
                         ADR_TYPE
                 FROM ADDRESS WHERE ADR_CAR_CODE = V_CAR_CODE AND ROWNUM=1;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                    NULL;
            END;

        V_TRACE := 'RISK ';
            FOR CARD_ONLINE_RISK_ROW IN (SELECT * FROM CUST_CHLD_ONLI_RISK WHERE CCO_CAR_CODE = V_CAR_CODE)
            LOOP
                BEGIN

                    BEGIN
                        INCREMENTE_CODE ('CUST_CHLD_ONLI_RISK',
                                         'CCO_CODE',
                                         P_CCO_CODE);
                      V_TRACE := 'CHLD_ONLI';
                        INSERT
                          INTO CUST_CHLD_ONLI_RISK (CCO_CODE,
                                                    CCO_PER_CODE,
                                                    CCO_TRAN_MIN,
                                                    CCO_TRAN_MAX,
                                                    CCO_TRAN_CUMU_MAX,
                                                    CCO_TRAN_CUMU_NBR,
                                                    CCO_CAR_CODE)
                        VALUES (P_CCO_CODE,
                                CARD_ONLINE_RISK_ROW.CCO_PER_CODE,
                                CARD_ONLINE_RISK_ROW.CCO_TRAN_MIN,
                                CARD_ONLINE_RISK_ROW.CCO_TRAN_MAX,
                                CARD_ONLINE_RISK_ROW.CCO_TRAN_CUMU_MAX,
                                CARD_ONLINE_RISK_ROW.CCO_TRAN_CUMU_NBR,
                                V_CARD_TABLE_REC.CAR_CODE);
                    END;

                   V_TRACE := 'RICO';
                    INSERT INTO CUST_CHLD_ONLI_RISK_RECO (CCO_CODE
                                        ,CCO_ATY_CODE
                                        ,CCO_MAG_CODE
                                        ,CCO_PCA_CODE
                                        ,CCO_DOM_CODE
                                        ,CCO_SLB_CODE
                                        ,CCO_TTY_CODE
                                        ,CCO_TCO_CODE
                                        ,CCO_INTE_MAIL_ORDE
                                        ,CCO_TRAN_MIN
                                        ,CCO_TRAN_MAX
                                        ,CCO_TRAN_CUMU_MAX
                                        ,CCO_TRAN_CUMU_NBR
                                        ,CCO_TRAN_CURR_AMOU
                                        ,CCO_TRAN_CURR_NBR
                                        ,CCO_TRAN_CURR_USAG_AMOU
                                        ,CCO_TRAN_CURR_USAG_NBR
                                        ,CCO_STAR_DATE
                                        ,CCO_END_DATE
                                        ,CCO_CCO_CODE
                                        ,CCO_TRAN_PERI_STAR
                                        ,CCO_TRAN_PERI_END
                                        ,CCO_TRAN_CUMU_MAX_SUPP
                                        ,CCO_TCG_CODE     )
                    SELECT XCUST_CHLD_ONLI_RISK_RECO.NEXTVAL
                                        ,CCO_ATY_CODE
                                        ,CCO_MAG_CODE
                                        ,CCO_PCA_CODE
                                        ,CCO_DOM_CODE
                                        ,CCO_SLB_CODE
                                        ,CCO_TTY_CODE
                                        ,CCO_TCO_CODE
                                        ,CCO_INTE_MAIL_ORDE
                                        ,CCO_TRAN_MIN
                                        ,CCO_TRAN_MAX
                                        ,CCO_TRAN_CUMU_MAX
                                        ,CCO_TRAN_CUMU_NBR
                                        ,CCO_TRAN_CURR_AMOU
                                        ,CCO_TRAN_CURR_NBR
                                        ,CCO_TRAN_CURR_USAG_AMOU
                                        ,CCO_TRAN_CURR_USAG_NBR
                                        ,CCO_STAR_DATE
                                        ,CCO_END_DATE
                                        ,P_CCO_CODE
                                        ,CCO_TRAN_PERI_STAR
                                        ,CCO_TRAN_PERI_END
                                        ,CCO_TRAN_CUMU_MAX_SUPP
                                        ,CCO_TCG_CODE
                    FROM CUST_CHLD_ONLI_RISK_RECO
                    WHERE CCO_CCO_CODE = CARD_ONLINE_RISK_ROW.CCO_CODE;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                    NULL;
                END;
            END LOOP;

            V_TRACE := 'ROUTING';
            BEGIN
                INSERT INTO CARDHOLDER_ROUTING (CRO_CODE,
                                                CRO_TRAN_CURR_CODE,
                                                CRO_AID,
                                                CRO_PAN,
                                                CRO_TRAN_CODE,
                                                CRO_TRAN_MCC,
                                                CRO_CUS_CODE,
                                                CRO_ACC_CODE)
                SELECT XCARDHOLDER_ROUTING.NEXTVAL,
                        CRO_TRAN_CURR_CODE,
                        CRO_AID,
                        V_CARD_TABLE_REC.CAR_NUMB,
                        CRO_TRAN_CODE,
                        CRO_TRAN_MCC,
                        CRO_CUS_CODE,
                        CRO_ACC_CODE
                 FROM CARDHOLDER_ROUTING WHERE CRO_PAN = V_CAR_NUMB;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                    NULL;
            END;

            V_TRACE := 'LINK';
            BEGIN
                INSERT INTO CARD_ACCOUNT_LINK (CAL_CODE,
                                                CAL_ACC_CODE,
                                                CAL_PAN,
                                                CAL_CUS_CODE,
                                                CAL_CHEQ_BOOK_FLAG)
                SELECT XCARD_ACCOUNT_LINK.NEXTVAL,
                        CAL_ACC_CODE,
                        V_CARD_TABLE_REC.CAR_NUMB,
                        CAL_CUS_CODE,
                        CAL_CHEQ_BOOK_FLAG
                 FROM CARD_ACCOUNT_LINK WHERE CAL_PAN = V_CAR_NUMB;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                    NULL;
            END;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := V_TRACE||SUBSTR (SQLERRM, 1,70);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSSECONDCARD',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSSECONDCARD;

   FUNCTION PROCESSREPLACECARD (V_REQUEST    IN OUT NOCOPY REPLACECARDRQ,
                                V_RESPONSE   IN OUT NOCOPY REPLACECARDRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        v_count            NUMBER;
        p_CARD_AUTO_CHANGE          CARD_AUTO_CHANGE%ROWTYPE;
        p_CARD_REPLACEMENT_MOTIF    CARD_REPLACEMENT_MOTIF%ROWTYPE;
        p_CARD_ROW                  CARD%ROWTYPE;
   BEGIN

           P_CARD_ROW := NULL;
        BEGIN
            SELECT  *
            INTO    P_CARD_ROW
            FROM    CARD
            WHERE   CAR_CODE    = V_REQUEST.INITIATOR.CARDCODE;
        EXCEPTION WHEN OTHERS THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90007_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90007_D;
            RETURN ERROR;
        END;

        P_CARD_REPLACEMENT_MOTIF := NULL;
        BEGIN
            SELECT  *
            INTO    P_CARD_REPLACEMENT_MOTIF
            FROM    CARD_REPLACEMENT_MOTIF
            WHERE   CRM_CODE    = V_REQUEST.REASON.REASONCODE
            AND CRM_BAN_CODE = P_CARD_ROW.CAR_BAN_CODE;
        EXCEPTION WHEN OTHERS THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90029_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90029_D;
            RETURN ERROR;
        END;

        P_CARD_REPLACEMENT_MOTIF := NULL;
        BEGIN
            SELECT  count(*)
            INTO    v_count
            FROM    CARD_AUTO_CHANGE
            WHERE   CAC_CAR_NUMB = P_CARD_ROW.CAR_NUMB
            AND     CAC_STATUS  = 'I';
        EXCEPTION WHEN OTHERS THEN
            v_count := 0;
        END;

        IF(v_count>0)
        THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90036_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90036_D;
            RETURN ERROR;
        END IF;

        P_CARD_AUTO_CHANGE := NULL;
        P_CARD_AUTO_CHANGE.CAC_BAN_CODE     := P_CARD_ROW.CAR_BAN_CODE;
        P_CARD_AUTO_CHANGE.CAR_FILE_NAME    := 'MOBILE';
        P_CARD_AUTO_CHANGE.CAR_FILE_PATH    := 'MOBILE';
        P_CARD_AUTO_CHANGE.CAC_INTG_USER    := 'MOBILE';
        P_CARD_AUTO_CHANGE.CAC_TYPE         := 'REPLACEMENT_PROCESS';
        P_CARD_AUTO_CHANGE.CAC_INTG_DATE    := SYSDATE;
        P_CARD_AUTO_CHANGE.CAC_STATUS       := 'I';
        P_CARD_AUTO_CHANGE.CAC_NEW_EFFE_DATE:= SYSDATE;
        P_CARD_AUTO_CHANGE.CAC_CAR_NUMB     := P_CARD_ROW.CAR_NUMB;

        P_CARD_AUTO_CHANGE.CAC_CODE         := XCARD_AUTO_CHANGE.NEXTVAL;
        INSERT INTO CARD_AUTO_CHANGE VALUES P_CARD_AUTO_CHANGE;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P31: '||SUBSTR (SQLERRM, 1,70);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSREPLACECARD',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSREPLACECARD;


   FUNCTION PROCESSREQRENEW (V_REQUEST    IN OUT NOCOPY REQRENEWRQ,
                                V_RESPONSE   IN OUT NOCOPY REQRENEWRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        p_CARD_ROW        CARD%ROWTYPE;
   BEGIN

           P_CARD_ROW := NULL;
        BEGIN
            SELECT  *
            INTO    P_CARD_ROW
            FROM    CARD
            WHERE   CAR_CODE    = V_REQUEST.INITIATOR.CARDCODE;
        EXCEPTION WHEN OTHERS THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90007_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90007_D;
            RETURN ERROR;
        END;

        IF(P_CARD_ROW.CAR_CARD_AUTO_RENE='A')
        THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90039_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90039_D;
            RETURN ERROR;
        END IF;

        BEGIN
            UPDATE CARD
            SET CAR_CARD_AUTO_RENE = 'A'
            WHERE CAR_CODE = P_CARD_ROW.CAR_CODE;
            COMMIT;
         EXCEPTION WHEN OTHERS THEN
           ROLLBACK;
           V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
           V_RESPONSE.STATUS.ERRORDESC := 'P32: '||SUBSTR (SQLERRM, 1,74);
           MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
               $$PLSQL_UNIT,
               'PROCESSREQRENEW',
               $$PLSQL_LINE,
               V_RESPONSE.STATUS.ERRORDESC);
           RETURN ERROR;
        END;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P6: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSREQRENEW',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSREQRENEW;

   FUNCTION PROCESSREQPIN (V_REQUEST    IN OUT NOCOPY REQPINRQ,
                                V_RESPONSE   IN OUT NOCOPY REQPINRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        p_CARD_ROW        CARD%ROWTYPE;
        V_COUNT           NUMBER;
        P_FEE_CODE        PIN_RECALCUL_FEES.PRF_CODE%TYPE;
        RESPONSE_CODE     VARCHAR(20);
   BEGIN

        P_CARD_ROW := NULL;
        BEGIN
            SELECT  *
            INTO    P_CARD_ROW
            FROM    CARD
            WHERE   CAR_CODE    = V_REQUEST.INITIATOR.CARDCODE;
        EXCEPTION WHEN OTHERS THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90007_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90007_D;
            RETURN ERROR;
        END;

        BEGIN
            SELECT  COUNT(*)
            INTO    V_COUNT
            FROM    DAILY_VALID_TRANS
            WHERE   VTR_TC_CODE    = '10102'
            AND VTR_CARD_NUMB = P_CARD_ROW.CAR_NUMB
            AND VTR_SETT_STAT = 'NULL';
        EXCEPTION WHEN OTHERS THEN
            V_COUNT := 0;
        END;

        IF (V_COUNT>0)
        THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90037_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90037_D;
            RETURN ERROR;
        END IF;

        BEGIN
            SELECT  PRF_CODE
            INTO    P_FEE_CODE
            FROM    PIN_RECALCUL_FEES
            WHERE   PRF_BAN_CODE    = P_CARD_ROW.CAR_BAN_CODE
            AND ROWNUM = 1;
        EXCEPTION WHEN OTHERS THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90007_C;
            V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90007_D;
            RETURN ERROR;
        END;

         ret := RECALCULATE_PIN (  P_CARD_ROW.CAR_BAN_CODE, P_CARD_ROW.CAR_NUMB, P_FEE_CODE,RESPONSE_CODE );/*test forced inside*/
         IF(ret!=CMS_Batches_Resp_Code_PKG.RC_OK)
         THEN
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_ERROR_C;
            V_RESPONSE.STATUS.ERRORDESC := 'RECALCULATE_PIN ERROR: '||RESPONSE_CODE;
            RETURN ERROR;
         END IF;


        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P33: '||SUBSTR (SQLERRM, 1,70);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSREQPIN',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSREQPIN;

   FUNCTION PROCESSREQCHECKBOOK (V_REQUEST    IN OUT NOCOPY CHECKBOOKRQ,
                                V_RESPONSE   IN OUT NOCOPY CHECKBOOKRS)
        RETURN NUMBER
    IS
       RET               NUMBER;

      MERCHANTNBR       VARCHAR2(15) := '999999000000001';
      CARDNBR           VARCHAR2(19);
      CARDEXPIRYDATE    VARCHAR2(4)  := '2202';
      AMOUNT            VARCHAR2(15) := '000000000000';
      ACTUALAMOUNT      VARCHAR2(24) := '000000000345000000000000';
      CURR              VARCHAR2(3)  := '504';
      CVC2              VARCHAR2(3)  := '123';

      PROCCODE          VARCHAR2(6)  := '310000';
      MCC               VARCHAR2(4)  := '5272';
      ACQCTRYCODE       VARCHAR2(3)  := '504';
      SCRUSERNAME       VARCHAR2(29) := 'MOBILE';
      SCRSVRPID         VARCHAR2(10) := '16566';
      RETREFNBR         VARCHAR2(12) := '550000546800';
      ORIGINALDATA      VARCHAR2(42) := '110054682211111111110000000032100000000333';
      AUTHNBR           VARCHAR2(6)  := '111111';
      RESPCODE          VARCHAR2(3);
      RESPMSG           VARCHAR2(40);
      AVAILABLEAMOUNT   VARCHAR2(15);
      F54               VARCHAR2(40);
      SPID              VARCHAR2(10);
      INTERFACES_ROW    INTERFACES%ROWTYPE;
      P_INTERNAL_STAN   VARCHAR2(6);
      P_CHK_SIZE        NUMBER(10);
      P_ACCOUNT_ROW     ACCOUNT%ROWTYPE;
      P_ACC_OVER_LINE_AMOU ACCOUNT.ACC_OVER_LINE_AMOU%TYPE;
      V_COUNT           NUMBER(2);
      ATM_TRANSACTION_REC   ATM_TRANSACTION%ROWTYPE;
      CARD_ROW              CARD%ROWTYPE;
   BEGIN


    INSERT_TRACKING (270955,'PROCESSREQCHECKBOOK..REQUESTID = '||V_REQUEST.INITIATOR.REQUESTID,0,0);
    INSERT_TRACKING (270955,'PROCESSREQCHECKBOOK..CLIENTID = '||V_REQUEST.INITIATOR.CLIENTID,0,0);
    INSERT_TRACKING (270955,'PROCESSREQCHECKBOOK..ACOUNTNBR = '||V_REQUEST.INITIATOR.ACOUNTNBR,0,0);


    BEGIN
        SELECT *
           INTO CARD_ROW
           FROM CARD
           WHERE CAR_CODE = V_REQUEST.INITIATOR.CARDCODE;
        EXCEPTION WHEN OTHERS THEN
          V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90007_C;
          V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90007_D;
          RETURN NOK;
    END;

    BEGIN
        SELECT CHK_SIZE
           INTO P_CHK_SIZE
           FROM CHECKSIZES
           WHERE CHK_CODE = V_REQUEST.CHECKCODE;
        EXCEPTION WHEN OTHERS THEN
          V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90038_C;
          V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90038_D;
          RETURN NOK;
    END;


    BEGIN
        SELECT COUNT(*)
           INTO V_COUNT
           FROM ATM_TRANSACTION
           WHERE ATR_TCO_CODE = '21012'
            AND NVL (ATR_RESP_CODE, '000') = '000'
            AND NVL (ATR_OUTG_CODE, 0) = 0
            AND ATR_CARD_NUMB = CARD_ROW.CAR_NUMB;
        EXCEPTION WHEN OTHERS THEN
            V_COUNT := 0;
    END;

    IF (V_COUNT>0)
    THEN
       V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90037_C;
       V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90037_D;
       RETURN NOK;
    END IF;

    RET := GET_INTERNAL_STAN( P_INTERNAL_STAN );
     IF RET <> 1 THEN
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90034_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90034_D;
        RETURN NOK;
     END IF;

     RETREFNBR := GET_JULIAN_DATE(SYSDATE)||TO_CHAR(SYSDATE, 'HH24')||P_INTERNAL_STAN;

    ATM_TRANSACTION_REC.ATR_CODE := XATM_TRANSACTION.NEXTVAL;
    ATM_TRANSACTION_REC.ATR_RETR_REFE_NUMB := RETREFNBR;
    ATM_TRANSACTION_REC.ATR_TCO_CODE := '21012';
    ATM_TRANSACTION_REC.ATR_DATE := SYSDATE ;
    ATM_TRANSACTION_REC.ATR_CARD_NUMB := CARD_ROW.CAR_NUMB;
    ATM_TRANSACTION_REC.ATR_BAN_CODE := CARD_ROW.CAR_BAN_CODE;
    -- ATM_TRANSACTION_REC.ATR_CARD_ACCE_TERM_IDEN_CODE,
    -- ATM_TRANSACTION_REC.ATR_AUTH_NUMB  ,
    ATM_TRANSACTION_REC.ATR_STAN :=P_INTERNAL_STAN;
    /* ATM_TRANSACTION_REC.ATR_TRAN_SERI_NUMB,
    ATM_TRANSACTION_REC..ATR_TRAC2,
    ATM_TRANSACTION_REC.ATR_ACQU_INST_IDEN_CODE,
    ATM_TRANSACTION_REC.ATR_RETR_REFE_NUMB ,*/
    ATM_TRANSACTION_REC.ATR_RESP_CODE :='000';
    /*   ATM_TRANSACTION_REC.ATR_CARD_ACCE_IDEN_CODE,
    ATM_TRANSACTION_REC.ATR_AMOU      ,
    ATM_TRANSACTION_REC.ATR_ACCO_FROM  ,
    ATM_TRANSACTION_REC.ATR_ATF_CODE_FROM  ,
    ATM_TRANSACTION_REC.ATR_ACCO_TO    ,
    ATM_TRANSACTION_REC.ATR_ATF_CODE_TO,
    ATM_TRANSACTION_REC.ATR_CUR_CODE   ,
    ATM_TRANSACTION_REC.ATR_ATT_CODE,
    ATM_TRANSACTION_REC.ATR_ATE_CODE,
    ATM_TRANSACTION_REC.ATR_STUB_POSI ,*/
    ATM_TRANSACTION_REC.ATR_CHEC_BOOK_COUN := 1;
    ATM_TRANSACTION_REC.ATR_CHEC_SIZE := P_CHK_SIZE;
    ATM_TRANSACTION_REC.ATR_CHEC_COUN :=  NULL;
    ATM_TRANSACTION_REC.ATR_DMO_CODE := '01';
    ATM_TRANSACTION_REC.ATR_ATS_CODE := 4;
    --   ATM_TRANSACTION_REC.ATR_REFE_FACT,
    --   ATM_TRANSACTION_REC.ATR_ATC_CODE  ,
    ATM_TRANSACTION_REC.ATR_OUTG_CODE := 0;
    ATM_TRANSACTION_REC.ATR_GENE_TRAN := 0;

    INSERT INTO ATM_TRANSACTION  VALUES ATM_TRANSACTION_REC;

          /*
    BEGIN
        SELECT *
            INTO INTERFACES_ROW
            FROM INTERFACES
            WHERE INT_CODE = 3;
        EXCEPTION
        WHEN OTHERS THEN
          V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90033_C;
          V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90033_D;
          RETURN NOK;
    END;

     SPID := INTERFACES_ROW.INT_PID;
     SCRSVRPID := SPID;




    RET := FUNCTION_IP_TO_WATCH.REQAUTHORIZATION_IP (  'N',--REPEAT_AUTH_FLAG
                                    MERCHANTNBR,
                                    CARDNBR,
                                    PROCCODE,
                                    CARDEXPIRYDATE,
                                    AMOUNT,
                                    CURR,
                                    NULL, --CVC2,
                                    0,--CVC2_IND
                                    MCC,
                                    ACQCTRYCODE,
                                    SCRUSERNAME,
                                    SCRSVRPID,
                                    RETREFNBR,
                                    RESPCODE,
                                    RESPMSG,
                                    AUTHNBR,
                                    AVAILABLEAMOUNT,
                                    F54);

    INSERT_TRACKING (270955,'PROCESSBALANCE...RET = '||RET,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...RESPCODE = '||RESPCODE,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...RESPMSG = '||RESPMSG,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...AUTHNBR = '||AUTHNBR,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...AVAILABLEAMOUNT = '||AVAILABLEAMOUNT,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...F54 = '||F54,0,0);

     IF RET <> 0 THEN
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90035_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90035_D||RESPCODE;
        RETURN NOK;
     END IF;

    CASE RESPCODE
    WHEN '000' THEN V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;

        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;

    ELSE

        BEGIN
            SELECT CRE_LABE INTO V_RESPONSE.STATUS.ERRORDESC
                FROM CODE_RESPONSE_F039
            WHERE CRE_CODE = RESPCODE;
            EXCEPTION WHEN OTHERS
            THEN
            V_RESPONSE.STATUS.ERRORDESC := NULL;
        END;

        V_RESPONSE.STATUS.ERRORCODE := '00'||RESPCODE;

        RETURN NOK;
    END CASE;
*/


    V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
    V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;


    RETURN OK;


    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P22: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSBALANCE',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSREQCHECKBOOK;

    FUNCTION PROCESSCOUNTRIESLIST (
        V_REQUEST    IN OUT NOCOPY COUNTRIESLISTRQ,
        V_RESPONSE   IN OUT NOCOPY COUNTRIESLISTRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_COUNT           NUMBER;
    BEGIN
     V_COUNT:=0;
     V_RESPONSE.COUNTRIES := NULL;
     V_RESPONSE.COUNTRIES := countrysresult ();

     FOR CURSOR_ROW IN (SELECT COU_CODE, COU_IDEN, COU_NAME, substr(nvl(COU_NAME,'XX'),0,2) ISO_ALPHA FROM COUNTRY ORDER BY COU_NAME)
       LOOP
           V_COUNT := V_COUNT + 1;

            V_RESPONSE.COUNTRIES.EXTEND;
            V_RESPONSE.COUNTRIES (V_COUNT) :=
                COUNTRYSTRUCT (NULL, NULL, NULL, NULL);

            V_RESPONSE.COUNTRIES (V_COUNT).countrycode:= CURSOR_ROW.COU_CODE  ;
            V_RESPONSE.COUNTRIES (V_COUNT).countryiden:= CURSOR_ROW.COU_IDEN ;
            V_RESPONSE.COUNTRIES (V_COUNT).countrydesc:= CURSOR_ROW.COU_NAME  ;
            V_RESPONSE.COUNTRIES (V_COUNT).countryiso:= CURSOR_ROW.ISO_ALPHA ;

        END LOOP;

        IF(V_COUNT =0)THEN
            V_RESPONSE.COUNTRIES := NULL;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.COUNTRIES := NULL;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P25: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSCOUNTRIESLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSCOUNTRIESLIST;

    FUNCTION PROCESSREASONSLIST (
        V_REQUEST    IN OUT NOCOPY REASONSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY REASONSLISTRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_COUNT           NUMBER;
    BEGIN
     V_COUNT:=0;
     V_RESPONSE.REASONS := NULL;
     V_RESPONSE.REASONS := REASONSRESULT ();

     FOR CURSOR_ROW IN (SELECT  CRM_CODE,CRM_IDEN,CRM_LABE FROM CARD_REPLACEMENT_MOTIF WHERE CRM_BAN_CODE=V_REQUEST.INITIATOR.BANKCODE)
       LOOP
           V_COUNT := V_COUNT + 1;

            V_RESPONSE.REASONS.EXTEND;
            V_RESPONSE.REASONS (V_COUNT) :=
                REASONSTRUCT (NULL,NULL,null);

            V_RESPONSE.REASONS (V_COUNT).reasoncode:= CURSOR_ROW.CRM_CODE  ;
            V_RESPONSE.REASONS (V_COUNT).reasoniden:= CURSOR_ROW.CRM_IDEN ;
            V_RESPONSE.REASONS (V_COUNT).reasonname:= CURSOR_ROW.CRM_LABE  ;

        END LOOP;

        IF(V_COUNT =0)THEN
            V_RESPONSE.REASONS := NULL;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.REASONS := NULL;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P26: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSREASONSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSREASONSLIST;


    FUNCTION PROCESSCHECKSIZESLIST (
        V_REQUEST    IN OUT NOCOPY CHECKSIZESLISTRQ,
        V_RESPONSE   IN OUT NOCOPY CHECKSIZESLISTRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_COUNT           NUMBER;
    BEGIN
     V_COUNT:=0;
     V_RESPONSE.CHECKSIZES := NULL;
     V_RESPONSE.CHECKSIZES := CHECKSIZESRESULT ();

     FOR CURSOR_ROW IN (SELECT CHK_CODE, CHK_SIZE FROM CHECKSIZES)
       LOOP
           V_COUNT := V_COUNT + 1;

            V_RESPONSE.CHECKSIZES.EXTEND;
            V_RESPONSE.CHECKSIZES (V_COUNT) :=
                CHECKSIZESTRUCT (NULL,NULL);

            V_RESPONSE.CHECKSIZES (V_COUNT).checkcode:= CURSOR_ROW.CHK_CODE  ;
            V_RESPONSE.CHECKSIZES (V_COUNT).checksize:= CURSOR_ROW.CHK_SIZE ;

        END LOOP;

        IF(V_COUNT =0)THEN
            V_RESPONSE.CHECKSIZES := NULL;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.CHECKSIZES := NULL;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P27: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSCHECKSIZESLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSCHECKSIZESLIST;


    FUNCTION PROCESSLOCATIONSLIST (
        V_REQUEST    IN OUT NOCOPY LOCATIONSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY LOCATIONSLISTRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
        V_COUNT           NUMBER;

      CURSOR LOCTS_CUR (
            V_BAN_CODE    BANK.BAN_CODE%TYPE)
        IS
            select * from
                (select  1 locationtype, LOC_LONG longitude, LOC_LAT latitude,  ate_code entitycode,
                ate_num entityiden, ate_labe entityname, null entityphone,decode( loc_address,null,bra_corp_name,loc_address) entityaddr
                from LOCATIONS_ENTITIES, atm_terminal, branch
                where LOC_ENT_NAME = 'ATM'
                and LOC_ENT_CODE = ate_code
                and ate_ban_code = V_BAN_CODE
                and ate_bra_code=bra_code
                UNION
                select  0 locationtype, LOC_LONG longitude, LOC_LAT latitude,   bra_code entitycode,
                 bra_iden entityiden, bra_corp_name entityname, loc_phone entityphone,decode( loc_address,null,bra_init || ' ' ||bra_corp_name ) entityaddr
                from LOCATIONS_ENTITIES, branch
                where LOC_ENT_NAME = 'BRANCH'
                and LOC_ENT_CODE = bra_code
                and  bra_bank_code= V_BAN_CODE
                UNION
                select  2 locationtype, LOC_LONG longitude, LOC_LAT latitude,   mer_code entitycode,
                 mer_iden entityiden,  mer_corp_name entityname,  decode( loc_phone,null,adr_pho1,loc_phone ) entityphone,
                  decode( loc_address,null, adr_adr1,loc_address) entityaddr
                from LOCATIONS_ENTITIES, merchant, address
                where LOC_ENT_NAME = 'AGENT'
                and LOC_ENT_CODE = mer_code
                and  mer_ban_code= V_BAN_CODE
                and adr_mer_code(+) = mer_code
                union
                select  3 locationtype, LOC_LONG longitude, LOC_LAT latitude,   ter_code entitycode,
                 ter_iden entityiden, mer_corp_name  entityname,  decode( loc_phone,null,adr_pho1,loc_phone ) entityphone,
                  decode( loc_address,null, adr_adr1,loc_address) entityaddr
                from LOCATIONS_ENTITIES, terminal, merchant, address
                where LOC_ENT_NAME = 'POS'
                and LOC_ENT_CODE = ter_code
                and  ter_ban_code= V_BAN_CODE
                and ter_mer_code = mer_code
                and adr_mer_code(+) = mer_code)
                order by locationtype;
    BEGIN
     V_COUNT:=0;
     V_RESPONSE.LOCATIONS := NULL;
     V_RESPONSE.LOCATIONS := LOCATIONSRESULT ();


     FOR CURSOR_ROW IN LOCTS_CUR (V_REQUEST.INITIATOR.BANKCODE)
       LOOP
           V_COUNT := V_COUNT + 1;

            V_RESPONSE.LOCATIONS.EXTEND;
            V_RESPONSE.LOCATIONS (V_COUNT) :=
                LOCATIONSTRUCT (NULL,
                                NULL,NULL,NULL,NULL,NULL,NULL,NULL);
            V_RESPONSE.LOCATIONS (V_COUNT).locationtype := CURSOR_ROW.locationtype;
            V_RESPONSE.LOCATIONS (V_COUNT).longitude := CURSOR_ROW.longitude ;
            V_RESPONSE.LOCATIONS (V_COUNT).latitude := CURSOR_ROW.latitude  ;
            V_RESPONSE.LOCATIONS (V_COUNT).entitycode := CURSOR_ROW.entitycode ;
            V_RESPONSE.LOCATIONS (V_COUNT).entityiden := CURSOR_ROW.entityiden ;
            V_RESPONSE.LOCATIONS (V_COUNT).entityname := CURSOR_ROW.entityname ;
            V_RESPONSE.LOCATIONS (V_COUNT).entityphone := CURSOR_ROW.entityphone ;
            V_RESPONSE.LOCATIONS (V_COUNT).entityaddr := CURSOR_ROW.entityaddr ;

        END LOOP;

        IF(V_COUNT =0)THEN
            V_RESPONSE.LOCATIONS := NULL;
        END IF;

        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.LOCATIONS := NULL;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P28: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSLOCATIONSLIST',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSLOCATIONSLIST;


    FUNCTION PROCESSSTATISTICS (
        V_REQUEST    IN OUT NOCOPY STATISTICSLISTRQ,
        V_RESPONSE   IN OUT NOCOPY STATISTICSRS)
        RETURN NUMBER
    IS
        RET               NUMBER;
    BEGIN

        V_RESPONSE.STATISTIC := NULL;
        V_RESPONSE.STATISTIC := STATISTICSTRUCT (NULL, NULL, NULL);
        V_RESPONSE.STATISTIC.STTC1 := NULL;
        V_RESPONSE.STATISTIC.STTC1 := LASTMONTHRESULT ();
        V_RESPONSE.STATISTIC.STTC2 := NULL;
        V_RESPONSE.STATISTIC.STTC2 := BYCOMPARERESULT ();
        V_RESPONSE.STATISTIC.STTC3 := NULL;
        V_RESPONSE.STATISTIC.STTC3 := PROPORTRESULT ();

        V_RESPONSE.STATISTIC.STTC1.EXTEND;
        V_RESPONSE.STATISTIC.STTC1(1) := lastmonthstruct (sysdate-30, 125366, 952, 'XOF',3);
        V_RESPONSE.STATISTIC.STTC1.EXTEND;
        V_RESPONSE.STATISTIC.STTC1(2) := lastmonthstruct (sysdate-31, 2258, 952, 'XOF',2);


        V_RESPONSE.STATISTIC.STTC2.EXTEND;
        V_RESPONSE.STATISTIC.STTC2(1) := bycomparestruct (1, 'GAB', 22563, 2226, 952, 'XOF',24500);
        V_RESPONSE.STATISTIC.STTC2.EXTEND;
        V_RESPONSE.STATISTIC.STTC2(2) := bycomparestruct (2, 'TPE', 5558, 2215, 952, 'XOF',7800);


        V_RESPONSE.STATISTIC.STTC3.EXTEND;
        V_RESPONSE.STATISTIC.STTC3(1) := proportstruct (1, 'GAB', 72, 2226, 952, 'XOF');
        V_RESPONSE.STATISTIC.STTC3.EXTEND;
        V_RESPONSE.STATISTIC.STTC3(2) := proportstruct (2, 'TPE', 18, 5885, 952, 'XOF');


        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATISTIC := NULL;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P29: '||SUBSTR (SQLERRM, 1,74);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSSTATISTICS',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSSTATISTICS;


   FUNCTION PROCESSTRANSFER (V_REQUEST    IN OUT NOCOPY TRANSFERRQ,
                                V_RESPONSE   IN OUT NOCOPY TRANSFERRS)
        RETURN NUMBER
    IS
      RET               NUMBER;

      MERCHANTNBR       VARCHAR2(15) := '999999000000001';
      CARDNBR           VARCHAR2(19);
      CARDEXPIRYDATE    VARCHAR2(4)  := '2202';
      AMOUNT            VARCHAR2(15) := '000000000000';
      ACTUALAMOUNT      VARCHAR2(24) := '000000000345000000000000';
      CURR              VARCHAR2(3)  := '504';
      CVC2              VARCHAR2(3)  := '123';

      PROCCODE          VARCHAR2(6)  := '310000';
      MCC               VARCHAR2(4)  := '5272';
      ACQCTRYCODE       VARCHAR2(3)  := '504';
      SCRUSERNAME       VARCHAR2(29) := 'MOBILE';
      SCRSVRPID         VARCHAR2(10) := '16566';
      RETREFNBR         VARCHAR2(12) := '550000546800';
      ORIGINALDATA      VARCHAR2(42) := '110054682211111111110000000032100000000333';
      AUTHNBR           VARCHAR2(6)  := '111111';
      RESPCODE          VARCHAR2(3);
      RESPMSG           VARCHAR2(40);
      AVAILABLEAMOUNT   VARCHAR2(15);
      F54               VARCHAR2(40);
      SPID              VARCHAR2(10);
      INTERFACES_ROW    INTERFACES%ROWTYPE;
      P_INTERNAL_STAN   VARCHAR2(6);
      P_ACCOUNT_ROW     ACCOUNT%ROWTYPE;
      P_ACC_OVER_LINE_AMOU ACCOUNT.ACC_OVER_LINE_AMOU%TYPE;
   BEGIN


    INSERT_TRACKING (270955,'PROCESSBALANCE..REQUESTID = '||V_REQUEST.INITIATOR.REQUESTID,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE..CLIENTID = '||V_REQUEST.INITIATOR.CLIENTID,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE..ACOUNTNBR = '||V_REQUEST.INITIATOR.ACOUNTNBR,0,0);


    BEGIN
        SELECT CAR_NUMB
           INTO CARDNBR
           FROM CARD
           WHERE CAR_CODE = V_REQUEST.INITIATOR.CARDCODE;
        EXCEPTION WHEN OTHERS THEN
          V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90007_C;
          V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90007_D;
          RETURN NOK;
    END;
          /*
    BEGIN
        SELECT *
            INTO INTERFACES_ROW
            FROM INTERFACES
            WHERE INT_CODE = 3;
        EXCEPTION
        WHEN OTHERS THEN
          V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90033_C;
          V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90033_D;
          RETURN NOK;
    END;

     SPID := INTERFACES_ROW.INT_PID;
     SCRSVRPID := SPID;

     RET := GET_INTERNAL_STAN( P_INTERNAL_STAN );
     IF RET <> 1 THEN
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90034_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90034_D;
        RETURN NOK;
     END IF;

     RETREFNBR := GET_JULIAN_DATE(SYSDATE)||TO_CHAR(SYSDATE, 'HH24')||P_INTERNAL_STAN;

    IF(typetransfer='1')
    THEN
        RET := FUNCTION_IP_TO_WATCH.REQAUTHORIZATION_IP (  'N',--REPEAT_AUTH_FLAG
                                        MERCHANTNBR,
                                        CARDNBR,
                                        PROCCODE,
                                        CARDEXPIRYDATE,
                                        AMOUNT,
                                        CURR,
                                        NULL, --CVC2,
                                        0,--CVC2_IND
                                        MCC,
                                        ACQCTRYCODE,
                                        SCRUSERNAME,
                                        SCRSVRPID,
                                        RETREFNBR,
                                        RESPCODE,
                                        RESPMSG,
                                        AUTHNBR,
                                        AVAILABLEAMOUNT,
                                        F54);
    ELSE
        RET := FUNCTION_IP_TO_WATCH.REQAUTHORIZATION_IP (  'N',--REPEAT_AUTH_FLAG
                                        MERCHANTNBR,
                                        CARDNBR,
                                        PROCCODE,
                                        CARDEXPIRYDATE,
                                        AMOUNT,
                                        CURR,
                                        NULL, --CVC2,
                                        0,--CVC2_IND
                                        MCC,
                                        ACQCTRYCODE,
                                        SCRUSERNAME,
                                        SCRSVRPID,
                                        RETREFNBR,
                                        RESPCODE,
                                        RESPMSG,
                                        AUTHNBR,
                                        AVAILABLEAMOUNT,
                                        F54);
    END IF;
    INSERT_TRACKING (270955,'PROCESSBALANCE...RET = '||RET,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...RESPCODE = '||RESPCODE,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...RESPMSG = '||RESPMSG,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...AUTHNBR = '||AUTHNBR,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...AVAILABLEAMOUNT = '||AVAILABLEAMOUNT,0,0);
    INSERT_TRACKING (270955,'PROCESSBALANCE...F54 = '||F54,0,0);

     IF RET <> 0 THEN
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_90035_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_90035_D||RESPCODE;
        RETURN NOK;
     END IF;

    CASE RESPCODE
    WHEN '000' THEN V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;

        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        V_RESPONSE.BALANCE := BALANCESTRUCT (   TO_NUMBER(SUBSTR(F54,9,12)/100),
                                         TO_NUMBER(SUBSTR(F54,9+20,12)/100),
                                         37,
                                         'XOF',
                                         SUBSTR(F54,8,1),
                                         SUBSTR(F54,8+20,1),
                                         RETREFNBR);

        RETURN OK;

    ELSE

        BEGIN
            SELECT CRE_LABE INTO V_RESPONSE.STATUS.ERRORDESC
                FROM CODE_RESPONSE_F039
            WHERE CRE_CODE = RESPCODE;
            EXCEPTION WHEN OTHERS
            THEN
            V_RESPONSE.STATUS.ERRORDESC := NULL;
        END;

        V_RESPONSE.STATUS.ERRORCODE := '00'||RESPCODE;

        RETURN NOK;
    END CASE;
*/
        V_RESPONSE.AUTH := AUTHORIZATIONSTRUCT ('125656','4554558',SYSDATE);
        V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SUCCESS_C;
        V_RESPONSE.STATUS.ERRORDESC := MB_RESP_PKG.MB_SUCCESS_D;

        RETURN OK;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK;
            V_RESPONSE.STATUS.ERRORCODE := MB_RESP_PKG.MB_SQL_C;
            V_RESPONSE.STATUS.ERRORDESC := 'P30: '||SUBSTR (SQLERRM, 1,70);
            MB_INTERFACE_TOOLS_PKG.TRACE_MB_EXCHANGE (
                $$PLSQL_UNIT,
                'PROCESSTRANSFER',
                $$PLSQL_LINE,
                V_RESPONSE.STATUS.ERRORDESC);
            RETURN ERROR;
    END PROCESSTRANSFER;

END MB_INTERFACE_TOOLS_PKG;
/

-- Grants for Package Body
GRANT EXECUTE ON api_sif_mobile.mb_interface_tools_pkg TO public
/


-- End of DDL Script for Package Body API_SIF_MOBILE.MB_INTERFACE_TOOLS_PKG

-- Start of DDL Script for Package Body API_SIF_MOBILE.MB_XML_TOOLS
-- Generated 14-Feb-21 19:47:40 from API_SIF_MOBILE@(DESCRIPTION =(ADDRESS_LIST =(ADDRESS = (PROTOCOL = TCP)(HOST = 172.18.1.199)(PORT = 1528)))(CONNECT_DATA =(SERVICE_NAME = afb12c)))

CREATE OR REPLACE 
PACKAGE BODY                        api_sif_mobile.mb_xml_tools is


  function get_xml_to_json_stylesheet return varchar2 is
    l_xslt_string varchar2(32000);
  begin

    l_xslt_string := '<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <xsl:output indent="no" omit-xml-declaration="yes" method="text" encoding="UTF-8" media-type="text/x-json"/>
  <xsl:strip-space elements="*"/>
  <!--contant-->
  <xsl:variable name="d">0123456789</xsl:variable>

  <!-- ignore document text -->
  <xsl:template match="text()[preceding-sibling::node() or following-sibling::node()]"/>

  <!-- string -->
  <xsl:template match="text()">
    <xsl:call-template name="escape-string">
      <xsl:with-param name="s" select="."/>
    </xsl:call-template>
  </xsl:template>

  <!-- Main template for escaping strings; used by above template and for object-properties
       Responsibilities: placed quotes around string, and chain up to next filter, escape-bs-string -->
  <xsl:template name="escape-string">
    <xsl:param name="s"/>
    <xsl:text>"</xsl:text>
    <xsl:call-template name="escape-bs-string">
      <xsl:with-param name="s" select="$s"/>
    </xsl:call-template>
    <xsl:text>"</xsl:text>
  </xsl:template>

  <!-- Escape the backslash (\) before everything else. -->
  <xsl:template name="escape-bs-string">
    <xsl:param name="s"/>
    <xsl:choose>
      <xsl:when test="contains($s,''\'')">
        <xsl:call-template name="escape-quot-string">
          <xsl:with-param name="s" select="concat(substring-before($s,''\''),''\\'')"/>
        </xsl:call-template>
        <xsl:call-template name="escape-bs-string">
          <xsl:with-param name="s" select="substring-after($s,''\'')"/>
        </xsl:call-template>
      </xsl:when>
      <xsl:otherwise>
        <xsl:call-template name="escape-quot-string">
          <xsl:with-param name="s" select="$s"/>
        </xsl:call-template>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>

  <!-- Escape the double quote ("). -->
  <xsl:template name="escape-quot-string">
    <xsl:param name="s"/>
    <xsl:choose>
      <xsl:when test="contains($s,'';'')">
        <xsl:call-template name="encode-string">
          <xsl:with-param name="s" select="concat(substring-before($s,'';''),''&quot;'')"/>
        </xsl:call-template>
        <xsl:call-template name="escape-quot-string">
          <xsl:with-param name="s" select="substring-after($s,'';'')"/>
        </xsl:call-template>
      </xsl:when>
      <xsl:otherwise>
        <xsl:call-template name="encode-string">
          <xsl:with-param name="s" select="$s"/>
        </xsl:call-template>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>

  <!-- Replace tab, line feed and/or carriage return by its matching escape code. Can''t escape backslash
       or double quote here, because they don''t replace characters (; becomes \t), but they prefix
       characters (\ becomes \\). Besides, backslash should be seperate anyway, because it should be
       processed first. This function can''t do that. -->
  <xsl:template name="encode-string">
    <xsl:param name="s"/>
    <xsl:choose>
      <!-- tab -->
      <xsl:when test="contains($s,'';'')">
        <xsl:call-template name="encode-string">
          <xsl:with-param name="s" select="concat(substring-before($s,'';''),''\t'',substring-after($s,'';''))"/>
        </xsl:call-template>
      </xsl:when>
      <!-- line feed -->
      <xsl:when test="contains($s,'';'')">
        <xsl:call-template name="encode-string">
          <xsl:with-param name="s" select="concat(substring-before($s,'';''),''\n'',substring-after($s,'';''))"/>
        </xsl:call-template>
      </xsl:when>
      <!-- carriage return -->
      <xsl:when test="contains($s,'';'')">
        <xsl:call-template name="encode-string">
          <xsl:with-param name="s" select="concat(substring-before($s,'';''),''\r'',substring-after($s,'';''))"/>
        </xsl:call-template>
      </xsl:when>
      <xsl:otherwise><xsl:value-of select="$s"/></xsl:otherwise>
    </xsl:choose>
  </xsl:template>

  <!-- number (no support for javascript mantise) -->
  <xsl:template match="text()[not(string(number())=''NaN'')]">
    <xsl:value-of select="."/>
  </xsl:template>

  <!-- boolean, case-insensitive -->
  <xsl:template match="text()[translate(.,''TRUE'',''true'')=''true'']">true</xsl:template>
  <xsl:template match="text()[translate(.,''FALSE'',''false'')=''false'']">false</xsl:template>

  <!-- item:null -->
  <xsl:template match="*[count(child::node())=0]">
    <xsl:call-template name="escape-string">
      <xsl:with-param name="s" select="local-name()"/>
    </xsl:call-template>
    <xsl:text>:null</xsl:text>
    <xsl:if test="following-sibling::*">,</xsl:if>
    <xsl:if test="not(following-sibling::*)">}</xsl:if>
  </xsl:template>

  <!-- object -->
  <xsl:template match="*" name="base">
    <xsl:if test="not(preceding-sibling::*)">{</xsl:if>
    <xsl:call-template name="escape-string">
      <xsl:with-param name="s" select="name()"/>
    </xsl:call-template>
    <xsl:text>:</xsl:text>
    <xsl:apply-templates select="child::node()"/>
    <xsl:if test="following-sibling::*">,</xsl:if>
    <xsl:if test="not(following-sibling::*)">}</xsl:if>
  </xsl:template>

  <!-- array -->
  <xsl:template match="*[count(../*[name(../*)=name(.)])=count(../*) and count(../*)&gt;1]">
    <xsl:if test="not(preceding-sibling::*)">[</xsl:if>
    <xsl:choose>
      <xsl:when test="not(child::node())">
        <xsl:text>null</xsl:text>
      </xsl:when>
      <xsl:otherwise>
        <xsl:apply-templates select="child::node()"/>
      </xsl:otherwise>
    </xsl:choose>
    <xsl:if test="following-sibling::*">,</xsl:if>
    <xsl:if test="not(following-sibling::*)">]</xsl:if>
  </xsl:template>

  <!-- convert root element to an anonymous container -->
  <xsl:template match="/">
    <xsl:apply-templates select="node()"/>
  </xsl:template>

</xsl:stylesheet>';

    return(l_xslt_string);
  end get_xml_to_json_stylesheet;

  ------------------------------------------------------------------------------------

  function xml2json(i_xml in xmltype) return xmltype is
    l_json xmltype;
  begin
    l_json := i_xml.transform(xmltype(get_xml_to_json_stylesheet));
    return(l_json);
  end;

  ------------------------------------------------------------------------------------

  function xmltype2clob(i_xml in xmltype) return clob is
  begin
    return(i_xml.getclobval());
  end;

  ------------------------------------------------------------------------------------

  function sql2xml(i_sql_string in varchar2) return xmltype is
    l_context_handle dbms_xmlgen.ctxhandle;
    l_xml            xmltype;
    l_rows           number;
  begin

    l_context_handle := dbms_xmlgen.newcontext(i_sql_string);
    dbms_xmlgen.setnullhandling(l_context_handle, dbms_xmlgen.empty_tag);

    l_xml  := dbms_xmlgen.getxmltype(l_context_handle, dbms_xmlgen.none);
    l_rows := dbms_xmlgen.getnumrowsprocessed(l_context_handle);

    dbms_xmlgen.closecontext(l_context_handle);

    if l_rows > 0 then
      return(l_xml);
    else
      return(null);
    end if;

  end;

begin
  null;
end MB_XML_TOOLS;
/

-- Grants for Package Body
GRANT EXECUTE ON api_sif_mobile.mb_xml_tools TO public
/


-- End of DDL Script for Package Body API_SIF_MOBILE.MB_XML_TOOLS

